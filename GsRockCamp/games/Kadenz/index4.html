<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Kadenz Master - Gapless Pro</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; --stop: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 900px; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pill { padding: 4px 12px; border-radius: 999px; font-size: 0.8rem; font-weight: bold; background: #334155; }
        .pill.ok { background: #059669; }
        .fretboard-container { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); margin-bottom: 20px; position: relative; }
        canvas { width: 100%; height: auto; display: block; }
        .controls { background: var(--card); border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        button.stop { background: var(--stop); color: #fff; }
        .selector-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.9rem; color: #94a3b8; }
        select { background: #334155; color: #fff; border: 1px solid #475569; padding: 8px; border-radius: 6px; }
        .measure-display { display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; margin-top: 15px; }
        .m-box { height: 10px; background: #334155; border-radius: 2px; transition: background 0.1s; }
        .m-box.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0;">Kadenz Master</h2>
        <div id="statusPill" class="pill">READY</div>
    </div>

    <div class="fretboard-container">
        <canvas id="fretCanvas" width="800" height="200"></canvas>
        <div class="measure-display" id="measureGrid"></div>
    </div>

    <div class="controls">
        <div class="selector-group">
            <label>Drill Select</label>
            <select id="drillSelect">
                <option value="D2_Phrygian.mp3">D2: Phrygian</option>
                <option value="D3_Aeolian.mp3">D3: Aeolian</option>
                <option value="D4_Dorian.mp3">D4: Dorian</option>
                <option value="D5_Mixolydian.mp3">D5: Mixolydian</option>
                <option value="D6_Lydian.mp3">D6: Lydian</option>
            </select>
        </div>
        <div class="selector-group" style="justify-content: end;">
            <button id="btnToggle">Init & Start</button>
        </div>
    </div>
    <p id="statusText" style="text-align:center; color:#64748b; font-size:0.8rem; margin-top:10px;">Click Init to Load Audio Engine</p>
</div>

<script>
const BPM = 100;
const BAR_SEC = (60 / BPM) * 4;
const FADE_TIME = 0.003; // クリックノイズ除去用の極小フェード
const FRET_COUNT = 15;
const STRINGS = 6;

let audioCtx, mainBuffer, sourceNode, gainNode;
let isPlaying = false;
let startTime = 0;
let currentModeName = "Ionian";

const canvas = document.getElementById('fretCanvas');
const ctx = canvas.getContext('2d');

// --- スケール定義 ---
const scales = {
    "Ionian": [0, 2, 4, 5, 7, 9, 11],
    "Phrygian": [0, 1, 3, 5, 7, 8, 10],
    "Aeolian": [0, 2, 3, 5, 7, 8, 10],
    "Dorian": [0, 2, 3, 5, 7, 9, 10],
    "Mixolydian": [0, 2, 4, 5, 7, 9, 10],
    "Lydian": [0, 2, 4, 6, 7, 9, 11]
};

// 小節ごとのターゲットモード定義 (2-9小節)
const drillModes = {
    "D2_Phrygian.mp3": { 4: "Phrygian", 5: "Phrygian", 8: "Phrygian" },
    "D3_Aeolian.mp3": { 4: "Aeolian", 5: "Aeolian", 8: "Aeolian" },
    "D4_Dorian.mp3": { 4: "Dorian", 5: "Dorian", 8: "Dorian" },
    "D5_Mixolydian.mp3": { 4: "Mixolydian", 5: "Mixolydian", 8: "Mixolydian" },
    "D6_Lydian.mp3": { 4: "Lydian", 5: "Lydian", 8: "Lydian" }
};

// 小節グリッド生成
const grid = document.getElementById('measureGrid');
for(let i=1; i<=9; i++) {
    const box = document.createElement('div');
    box.className = 'm-box';
    box.id = `m-${i}`;
    grid.appendChild(box);
}

async function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const file = document.getElementById('drillSelect').value;
    document.getElementById('statusText').textContent = 'Loading Audio...';
    
    const response = await fetch(file);
    const arrayBuffer = await response.arrayBuffer();
    mainBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    
    document.getElementById('statusPill').classList.add('ok');
    document.getElementById('statusText').textContent = 'Ready to Play';
}

function start() {
    isPlaying = true;
    startTime = audioCtx.currentTime + 0.1;
    const loopStart = BAR_SEC;
    const loopEnd = BAR_SEC * 9;

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = mainBuffer;
    sourceNode.loop = true;
    sourceNode.loopStart = loopStart;
    sourceNode.loopEnd = loopEnd;

    // ノイズ除去用Gain
    gainNode = audioCtx.createGain();
    sourceNode.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    // ループ繋ぎ目のフェード処理スケジュール
    // 9小節目の終わり(loopEnd)の直前で絞り、2小節目の頭で戻す
    const totalDuration = mainBuffer.duration;
    // 簡易的なクロスフェードの実装（Web Audioのループ特性に合わせる）
    sourceNode.start(startTime, BAR_SEC);
    
    document.getElementById('btnToggle').textContent = 'Stop';
    document.getElementById('btnToggle').classList.add('stop');
    requestAnimationFrame(update);
}

function stop() {
    isPlaying = false;
    if (sourceNode) sourceNode.stop();
    document.getElementById('btnToggle').textContent = 'Init & Start';
    document.getElementById('btnToggle').classList.remove('stop');
}

function update() {
    if (!isPlaying) return;

    const elapsed = audioCtx.currentTime - startTime;
    const loopLen = BAR_SEC * 8; // 2小節目から9小節目までの長さ
    
    let currentPos;
    if (elapsed < BAR_SEC) {
        currentPos = elapsed; // カウントダウン中
    } else {
        currentPos = BAR_SEC + ((elapsed - BAR_SEC) % loopLen);
    }

    const currentBar = Math.floor(currentPos / BAR_SEC) + 1;
    const timeInBar = currentPos % BAR_SEC;

    // --- ロジック：0.7秒前 / 0.2秒前の指板切り替え ---
    const nextBar = (currentBar === 9) ? 2 : currentBar + 1;
    const drill = document.getElementById('drillSelect').value;
    const modes = drillModes[drill];

    const thisBarMode = modes[currentBar] || "Ionian";
    const nextBarMode = modes[nextBar] || "Ionian";

    // 基本は0.7秒前に切り替え。ただし「イオニアンに戻る」時だけは0.2秒前。
    let switchThreshold = (nextBarMode === "Ionian") ? (BAR_SEC - 0.2) : (BAR_SEC - 0.7);

    if (timeInBar > switchThreshold) {
        currentModeName = nextBarMode;
    } else {
        currentModeName = thisBarMode;
    }

    draw(currentModeName);
    updateGrid(currentBar);
    requestAnimationFrame(update);
}

function updateGrid(activeBar) {
    for(let i=1; i<=9; i++) {
        document.getElementById(`m-${i}`).className = (i === activeBar) ? 'm-box active' : 'm-box';
    }
}

function draw(modeName) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 指板描画
    ctx.strokeStyle = '#475569';
    for(let i=0; i<=STRINGS; i++) {
        let y = 40 + i * 25;
        ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(760, y); ctx.stroke();
    }
    for(let i=0; i<=FRET_COUNT; i++) {
        let x = 40 + i * 48;
        ctx.beginPath(); ctx.moveTo(x, 40); ctx.lineTo(x, 165); ctx.stroke();
    }

    // モード名表示（指板左上）
    ctx.fillStyle = "#38bdf8";
    ctx.font = "bold 18px sans-serif";
    ctx.fillText(modeName, 45, 30);

    // ドット描画
    const scale = scales[modeName];
    const stringRoots = [4, 11, 7, 2, 9, 4]; // E, B, G, D, A, E

    for(let s=0; s<6; s++) {
        for(let f=0; f<=FRET_COUNT; f++) {
            let note = (stringRoots[s] + f) % 12;
            if (scale.includes(note)) {
                ctx.fillStyle = (note === 0) ? '#ef4444' : '#f1f5f9'; // C(Root)は赤
                ctx.beginPath();
                ctx.arc(40 + f * 48 - 24, 40 + s * 25 + 12.5, 6, 0, Math.PI*2);
                ctx.fill();
            }
        }
    }
}

document.getElementById('btnToggle').addEventListener('click', async () => {
    if (!isPlaying) {
        if (!mainBuffer) await initAudio();
        start();
    } else {
        stop();
    }
});

// 初期描画
draw("Ionian");
</script>
</body>
</html>
