<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kadenz Drill Player</title>
  <style>
    :root{
      --bg:#0f1220; --text:#e8e8f0; --muted:#a9adc4;
      --accent:#7dd3fc; --danger:#fb7185; --ok:#34d399;
      --caution:#fb923c;
      --line:#2a2f4a;
      --cell:#11152a; --cell2:#10142a;
      --hl: rgba(125,211,252,.22);
    }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif; background:linear-gradient(180deg,var(--bg),#0b0d18); color:var(--text); }
    header{ padding:18px 18px 10px; }
    h1{ margin:0; font-size:18px; letter-spacing:.4px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .wrap{ padding:0 18px 28px; max-width: 1400px; margin: 0 auto; }

    .bar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      background:rgba(255,255,255,.04); border:1px solid var(--line);
      border-radius:12px; padding:12px;
    }
    .selectWrap{ flex: 1 1 560px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select{ width:min(980px, 100%); padding:12px 14px; border-radius:14px; border:1px solid var(--line); background:#f2f2f7; color:#000; font-weight:900; font-size:26px; outline:none; }
    button{ cursor:pointer; border:1px solid var(--line); background:linear-gradient(180deg, rgba(125,211,252,.25), rgba(125,211,252,.12)); color:var(--text); padding:14px 18px; border-radius:14px; font-weight:900; font-size:20px; }
    button.stop{ background:linear-gradient(180deg, rgba(251,113,133,.28), rgba(251,113,133,.14)); }

    .toggles{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .toggles label{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:14px; cursor:pointer; }
    .now{ margin-left:auto; color:var(--muted); font-size:14px; display:flex; gap:10px; align-items:center; }
    .pill{ display:inline-flex; gap:6px; align-items:center; border:1px solid var(--line); border-radius:999px; padding:6px 12px; background:rgba(255,255,255,.03); color:var(--text); font-size:12px; }
    .pill.ok{ border-color: rgba(52,211,153,.35); }
    .pill.stop{ border-color: rgba(251,113,133,.35); }

    .blockSelector { margin-top: 14px; padding: 12px; background: rgba(125,211,252,0.05); border-radius: 12px; border: 1px solid var(--line); font-size: 13px; }
    .blockSelector label { margin-right: 15px; color: var(--accent); cursor: pointer; }

    .bigTitle{ margin-top:14px; padding:18px; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.03); display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .bigTitle h2{ margin:0; font-size:34px; }
    .tag{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid rgba(251,113,133,.35); background:rgba(251,113,133,.10); color:var(--text); font-family: monospace; }

    .gridWrap{ margin-top:14px; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.03); overflow:hidden; }
    .gridRow{ display:grid; grid-template-columns: 200px repeat(8, minmax(0, 1fr)); border-bottom:1px solid rgba(42,47,74,.55); }
    .rowLabel{ color:var(--muted); font-size:16px; padding:24px 14px; border-right:1px solid var(--line); background:rgba(0,0,0,.18); display:flex; align-items:center; }
    .cell{ padding:39px 14px; text-align:center; border-right:1px solid rgba(42,47,74,.55); background: var(--cell); font-family: monospace; font-weight:900; }
    .degreeCell, .chordCell{ font-size:58px; }
    .modeCell{ font-size:26px; line-height:1.15; }
    .activeBar{ background: var(--hl) !important; }

    #fretContainer { margin-top: 20px; }
    .fretLabel { font-size: 24px; color: var(--muted); margin-bottom: 5px; font-weight: bold; }
    canvas { width:100%; border-radius:8px; background:#000; }
  </style>
</head>
<body>

<header>
  <h1>Kadenz Drill Player</h1>
  <div class="sub">„Éó„É´„ÉÄ„Ç¶„É≥„Åß„Éâ„É™„É´ÈÅ∏Êäû ‚Üí <b>Start/Stop</b>Ôºà<kbd>Space</kbd>Ôºâ„Åß„É´„Éº„Éó„ÄÇBPM=100Âõ∫ÂÆö„ÄÇÂÖàÈ†≠1Â∞èÁØÄ„ÅØ„Ç´„Ç¶„É≥„Éà„ÄÇ</div>
</header>

<div class="wrap">
  <div class="bar">
    <div class="selectWrap">
      <select id="drillSelect"></select>
    </div>
    <button id="btnToggle">Start</button>
    <div class="toggles">
      <label><input id="toggleCaution" type="checkbox" checked /> Ë¶ÅÊ≥®ÊÑèÈü≥ Ë°®Á§∫</label>
      <label><input id="toggleModes" type="checkbox" checked /> ‰ΩøÁî®„É¢„Éº„Éâ Ë°®Á§∫</label>
    </div>
    <div class="now">
      <span id="statusPill" class="pill stop"><small>Status</small><span id="statusText">STOP</span></span>
      <span class="pill"><small>BPM</small><span class="mono">100</span></span>
      <span class="pill"><small>Now</small><span id="nowText">‚Äî</span></span>
    </div>
  </div>

  <div class="blockSelector" id="blockPanel">
    <span style="color:var(--muted); margin-right:10px;">È†òÂüüÊã°Âºµ:</span>
  </div>

  <div class="bigTitle">
    <h2 id="bigTitleText">‚Äî</h2>
    <div id="cautionTags"></div>
  </div>

  <div class="gridWrap">
    <div class="gridRow" id="rowDegree"></div>
    <div class="gridRow" id="rowChord"></div>
    <div class="gridRow" id="rowMode"></div>
  </div>

  <div id="fretContainer">
    <div class="fretLabel" id="fretTitle">FRETBOARD</div>
    <canvas id="fretboardCanvas" width="1200" height="300"></canvas>
  </div>
</div>

<script>
(() => {
  const BPM = 100;
  const BAR_SEC = (60 / BPM) * 4;
  const COUNTIN_BARS = 1;
  const DISPLAY_BARS = 8;
  const LOOP_SEC = BAR_SEC * (DISPLAY_BARS + COUNTIN_BARS);
  const R = 'R';

  const BLOCKS = [
    { id: 'b5_3',  label: '5Âº¶3F',  range: [0, 8, 3, 6] },
    { id: 'b6_8',  label: '6Âº¶8F',  range: [5, 12, 4, 6] },
    { id: 'b3_5',  label: '3Âº¶5F',  range: [3, 12, 1, 4] },
    { id: 'b4_10', label: '4Âº¶10F', range: [8, 15, 2, 5] },
    { id: 'b2_13', label: '2Âº¶13F', range: [10, 18, 1, 4] },
    { id: 'b3_17', label: '3Âº¶17F', range: [15, 23, 1, 4] }
  ];

  const MODE_MAP = {
    '„Ç§„Ç™„Éã„Ç¢„É≥': [0, 2, 4, 5, 7, 9, 11],
    '„Éü„ÇØ„ÇΩ„É™„Éá„Ç£„Ç¢„É≥': [0, 2, 4, 5, 7, 9, 10],
    '„É™„Éá„Ç£„Ç¢„É≥': [0, 2, 4, 6, 7, 9, 11],
    '„Éï„É™„Ç∏„Ç¢„É≥': [0, 1, 3, 5, 7, 8, 10],
    '„Ç®„Ç™„É™„Ç¢„É≥': [0, 2, 3, 5, 7, 8, 10],
    '„Éä„ÉÅ„É•„É©„É´„Éû„Ç§„Éä„Éº': [0, 2, 3, 5, 7, 8, 10],
    '„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº': [0, 2, 3, 5, 7, 8, 11],
    '„É°„É≠„Éá„Ç£„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº': [0, 2, 3, 5, 7, 9, 11],
    'A„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº': { root: 9, intervals: [0, 2, 3, 5, 7, 8, 11] },
    'D„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº': { root: 2, intervals: [0, 2, 3, 5, 7, 8, 11] },
    'G„Ç§„Ç™„Éã„Ç¢„É≥': { root: 7, intervals: [0, 2, 4, 5, 7, 9, 11] }
  };

  const NOTE_INT = { 'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11 };
  const strings = [4, 11, 7, 2, 9, 4];

  const drills = [
    { id:'A01', file:'A01_CFGCCFGC.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄÁéãÈÅìÈÄ≤Ë°åÔºà‚Ö†-‚Ö£-‚Ö§-‚Ö†Ôºâ', degree:['‚Ö†','‚Ö£','‚Ö§','‚Ö†','‚Ö†','‚Ö£','‚Ö§','‚Ö†'], chords:['C','F','G','C','C','F','G','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R,R,R,R,R], caution:[] },
    { id:'A02', file:'A02_Dm7G7Cmaj7Am7Dm7G7Cmaj7Cmaj7.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄ„ÉÑ„Éº„Éï„Ç°„Ç§„Éñ„ÉØ„É≥ÂèçÂæ©', degree:['‚Ö°m7','‚Ö§7','‚Ö†maj7','‚Ö•m7','‚Ö°m7','‚Ö§7','‚Ö†maj7','‚Ö†maj7'], chords:['Dm7','G7','Cmaj7','Am7','Dm7','G7','Cmaj7','Cmaj7'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R,R,R,R,R], caution:[] },
    { id:'A03', file:'A03_CBbCBbCDm7FC.mp3', title:'C„Éü„ÇØ„ÇΩ„É™„Éá„Ç£„Ç¢„É≥„Éâ„É™„É´„ÄÄ‚ô≠‚Ö¶‚Üí‚Ö†', degree:['‚Ö†','‚ô≠‚Ö¶','‚Ö†','‚ô≠‚Ö¶','‚Ö†','‚Ö°m7','‚Ö£','‚Ö†'], chords:['C','Bb','C','Bb','C','Dm7','F','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥','„Éü„ÇØ„ÇΩ„É™„Éá„Ç£„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥','„Éü„ÇØ„ÇΩ„É™„Éá„Ç£„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R], caution:['Bb'] },
    { id:'A04', file:'A04_CE7AmD7Dm7G7CC.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄ„Çª„Ç´„É≥„ÉÄ„É™2ÈÄ£', degree:['‚Ö†','‚Ö§/‚Ö•','‚Ö•m','‚Ö§/‚Ö§','‚Ö°m7','‚Ö§7','‚Ö†','‚Ö†'], chords:['C','E7','Am','D7','Dm7','G7','C','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥','A„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº','„Ç§„Ç™„Éã„Ç¢„É≥','G„Ç§„Ç™„Éã„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R], caution:['G#','F#'] },
    { id:'A05', file:'A05_Dm7G7CDbCDm7G7C.mp3', title:'C„Éï„É™„Ç∏„Ç¢„É≥„Éâ„É™„É´„ÄÄ‚ô≠‚Ö°‚Üí‚Ö†', degree:['‚Ö°m7','‚Ö§7','‚Ö†','‚ô≠‚Ö°','‚Ö†','‚Ö°m7','‚Ö§7','‚Ö†'], chords:['Dm7','G7','C','Db','C','Dm7','G7','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥',R,R,'„Éï„É™„Ç∏„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R], caution:['Db'] },
    { id:'A06', file:'A06_CCFmCDm7G7CC.mp3', title:'C„Ç®„Ç™„É™„Ç¢„É≥„Éâ„É™„É´„ÄÄ‚Ö£m‚Üí‚Ö†', degree:['‚Ö†','‚Ö†','‚Ö£m','‚Ö†','‚Ö°m7','‚Ö§7','‚Ö†','‚Ö†'], chords:['C','C','Fm','C','Dm7','G7','C','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥',R,'„Ç®„Ç™„É™„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,R,R], caution:['Ab'] },
    { id:'A07', file:'A07_CA7Dm7G7CA7Dm7C.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄA7„Éâ„É™„É´', degree:['‚Ö†','‚Ö§/‚Ö°','‚Ö°m7','‚Ö§7','‚Ö†','‚Ö§/‚Ö°','‚Ö°m7','‚Ö†'], chords:['C','A7','Dm7','G7','C','A7','Dm7','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥','D„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº','„Ç§„Ç™„Éã„Ç¢„É≥',R,'„Ç§„Ç™„Éã„Ç¢„É≥','D„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº','„Ç§„Ç™„Éã„Ç¢„É≥',R], caution:['C#'] },
    { id:'A08', file:'A08_CD7G7CCD7G7C.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄD7„Éâ„É™„É´', degree:['‚Ö†','‚Ö§/‚Ö§','‚Ö§7','‚Ö†','‚Ö†','‚Ö§/‚Ö§','‚Ö§7','‚Ö†'], chords:['C','D7','G7','C','C','D7','G7','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥','G„Ç§„Ç™„Éã„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,'G„Ç§„Ç™„Éã„Ç¢„É≥','„Ç§„Ç™„Éã„Ç¢„É≥',R], caution:['F#'] },
    { id:'A09', file:'A09_CE7AmCCE7AmC.mp3', title:'C„Ç§„Ç™„Éã„Ç¢„É≥„Éâ„É™„É´„ÄÄE7„Éâ„É™„É´', degree:['‚Ö†','‚Ö§/‚Ö•','‚Ö•m','‚Ö†','‚Ö†','‚Ö§/‚Ö•','‚Ö•m','‚Ö†'], chords:['C','E7','Am','C','C','E7','Am','C'], modes:['„Ç§„Ç™„Éã„Ç¢„É≥','A„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº','„Ç§„Ç™„Éã„Ç¢„É≥',R,R,'A„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº','„Ç§„Ç™„Éã„Ç¢„É≥',R], caution:['G#'] },
    { id:'A10', file:'A10_CCDDCDGC.mp3', title:'C„É™„Éá„Ç£„Ç¢„É≥„Éâ„É™„É´„ÄÄ#4Âõ∫ÂÆö', degree:['‚Ö†','‚Ö†','‚Ö°','‚Ö°','‚Ö†','‚Ö°','‚Ö§','‚Ö†'], chords:['C','C','D','D','C','D','G','C'], modes:['„É™„Éá„Ç£„Ç¢„É≥',R,R,R,R,R,R,R], caution:['F#'] },
    { id:'M01', file:'M01_CmCmBbBbAbAbGmCm.mp3', title:'C„Éä„ÉÅ„É•„É©„É´„Éû„Ç§„Éä„Éº„Éâ„É™„É´', degree:['‚Ö†m','‚Ö†m','‚ô≠‚Ö¶','‚ô≠‚Ö¶','‚ô≠‚Ö•','‚ô≠‚Ö•','‚Ö§m','‚Ö†m'], chords:['Cm','Cm','Bb','Bb','Ab','Ab','Gm','Cm'], modes:['„Éä„ÉÅ„É•„É©„É´„Éû„Ç§„Éä„Éº',R,R,R,R,R,R,R], caution:['Eb','Ab','Bb'] },
    { id:'M02', file:'M02_CmCmAbAbGGCmCm.mp3', title:'C„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº„Éâ„É™„É´', degree:['‚Ö†m','‚Ö†m','‚ô≠‚Ö•','‚ô≠‚Ö•','‚Ö§','‚Ö§','‚Ö†m','‚Ö†m'], chords:['Cm','Cm','Ab','Ab','G','G','Cm','Cm'], modes:['„Éè„Éº„É¢„Éã„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº',R,R,R,R,R,R,R], caution:['B','Eb','Ab'] },
    { id:'M03', file:'M03_CmCmFFGGCm6Cm.mp3', title:'C„É°„É≠„Éá„Ç£„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº„Éâ„É™„É´', degree:['‚Ö†m','‚Ö†m','‚Ö£','‚Ö£','‚Ö§','‚Ö§','‚Ö†m6','‚Ö†m'], chords:['Cm','Cm','F','F','G','G','Cm6','Cm'], modes:['„É°„É≠„Éá„Ç£„ÉÉ„ÇØ„Éû„Ç§„Éä„Éº',R,R,R,R,R,R,R], caution:['A','B','Eb'] }
  ];

  let activeIndex = 0, isPlaying = false, lastDrawnBar = -1, hlTimer = null;
  const audio = new Audio();
  const canvas = document.getElementById('fretboardCanvas');
  const ctx = canvas.getContext('2d');

  // UI Setup
  const blockPanel = document.getElementById('blockPanel');
  BLOCKS.forEach(b => blockPanel.innerHTML += `<label><input type="checkbox" value="${b.id}" class="blockCheck"> ${b.label}</label>`);
  blockPanel.innerHTML += `<label style="color:#fff;"><input type="checkbox" id="allCheck"> ALL</label>`;

  function drawFretboard(modeName, cautionList) {
    const margin = 40, w = canvas.width, h = canvas.height, boardW = w - margin * 2, boardH = h - margin * 2;
    const fretCount = 23, fretW = boardW / (fretCount + 1), stringH = (boardH - 40) / 5;
    const offsetTop = margin + 40; // „Éï„É¨„ÉÉ„ÉàÁï™Âè∑Áî®„ÅÆÈöôÈñì

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#f3d9a2'; ctx.fillRect(margin, offsetTop, boardW, boardH - 40);

    // 1. „Éï„É¨„ÉÉ„ÉàÁ∑ö & Áï™Âè∑Ôºà„Éç„ÉÉ„ÇØ‰∏äÈÉ®Ôºâ
    ctx.strokeStyle = '#888'; ctx.lineWidth = 2; ctx.fillStyle = '#aaa'; ctx.font = 'bold 16px Arial';
    for (let f = 0; f <= fretCount + 1; f++) {
      const x = margin + f * fretW;
      ctx.beginPath(); ctx.moveTo(x, offsetTop); ctx.lineTo(x, offsetTop + boardH - 40); ctx.stroke();
      if ([3, 5, 7, 9, 12, 15, 17, 19, 21, 23].includes(f)) ctx.fillText(f.toString(), x - 8, offsetTop - 10);
    }
    // 2. Âº¶
    ctx.strokeStyle = '#555';
    for (let s = 0; s < 6; s++) {
      const y = offsetTop + s * stringH;
      ctx.beginPath(); ctx.moveTo(margin, y); ctx.lineTo(margin + boardW, y); ctx.stroke();
    }

    const allChecked = document.getElementById('allCheck').checked;
    const checkedIds = Array.from(document.querySelectorAll('.blockCheck:checked')).map(el => el.value);
    const isVisible = (s, f) => (allChecked || checkedIds.length === 0) || BLOCKS.some(b => checkedIds.includes(b.id) && f >= b.range[0] && f <= b.range[1] && (s+1) >= b.range[2] && (s+1) <= b.range[3]);

    let mData = MODE_MAP[modeName], root = mData?.root ?? 0, intervals = Array.isArray(mData) ? mData : (mData?.intervals ?? []);
    const scaleNotes = intervals.map(i => (root + i) % 12), cautions = (cautionList || []).map(n => NOTE_INT[n]);

    for (let s = 0; s < 6; s++) {
      for (let f = 0; f <= fretCount; f++) {
        const note = (strings[s] + f) % 12;
        if (scaleNotes.includes(note)) {
          const v = isVisible(s, f);
          ctx.globalAlpha = v ? 1.0 : 0.05;
          ctx.beginPath(); ctx.arc(margin + f * fretW - (f === 0 ? 0 : fretW / 2), offsetTop + s * stringH, 11, 0, Math.PI * 2);
          ctx.fillStyle = (note === root) ? '#fb7185' : (cautions.includes(note) ? '#fb923c' : '#ffffff');
          ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1.5; ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1.0;
    document.getElementById('fretTitle').textContent = `FRETBOARD (${modeName})`;
  }

  function highlightBar() {
    if (!isPlaying) return;
    const tLoop = audio.currentTime % LOOP_SEC, countIn = BAR_SEC;
    const d = drills[activeIndex];

    // ‰∫àÂ†±„É≠„Ç∏„ÉÉ„ÇØ
    const tCheck = (audio.currentTime + 0.8) % LOOP_SEC;
    const nextIdx = Math.min(7, Math.floor((tCheck - countIn) / BAR_SEC));
    const nextMode = (d.modes[nextIdx] === R || nextIdx < 0) ? d.modes[0] : d.modes[nextIdx];
    const preview = (nextMode === '„Ç§„Ç™„Éã„Ç¢„É≥') ? 0.3 : 0.7;
    const tPrev = (audio.currentTime + preview) % LOOP_SEC;

    if (tPrev >= countIn) {
      const bar = Math.min(7, Math.floor((tPrev - countIn) / BAR_SEC));
      if (bar !== lastDrawnBar) {
        drawFretboard(d.modes[bar] === R ? d.modes[0] : d.modes[bar], d.caution);
        lastDrawnBar = bar;
      }
    }
    // „Ç∞„É™„ÉÉ„ÉâÂº∑Ë™ø
    if (tLoop >= countIn) {
      const rb = Math.floor((tLoop - countIn) / BAR_SEC);
      document.querySelectorAll('.cell').forEach(c => c.classList.toggle('activeBar', c.dataset.bar == rb));
    } else {
      document.querySelectorAll('.cell').forEach(c => c.classList.remove('activeBar'));
    }
  }

  function renderRow(container, labelText, values, className) {
    container.innerHTML = `<div class="rowLabel">${labelText}</div>` + values.map((v, i) => `<div class="cell ${className}" data-bar="${i}">${v === R ? 'ùÑé' : v}</div>`).join('');
  }

  function renderSelected() {
    const d = drills[activeIndex];
    document.getElementById('bigTitleText').textContent = d.title;
    document.getElementById('nowText').textContent = d.id;
    const tags = document.getElementById('cautionTags');
    tags.innerHTML = document.getElementById('toggleCaution').checked ? d.caution.map(c => `<span class="tag">${c}</span>`).join('') : '';
    
    renderRow(document.getElementById('rowDegree'), '‚ë†„Éá„Ç£„Ç∞„É™„Éº', d.degree, 'degreeCell');
    renderRow(document.getElementById('rowChord'), '‚ë°„Ç≥„Éº„ÉâÈÄ≤Ë°å', d.chords, 'chordCell');
    renderRow(document.getElementById('rowMode'), '‚ë¢‰ΩøÁî®„É¢„Éº„Éâ', d.modes, 'modeCell');
    
    document.getElementById('rowMode').style.display = document.getElementById('toggleModes').checked ? 'grid' : 'none';
    drawFretboard(d.modes[0], d.caution);
    lastDrawnBar = -1;
  }

  const drillSelect = document.getElementById('drillSelect');
  drills.forEach((d, i) => drillSelect.innerHTML += `<option value="${i}">${d.title}</option>`);

  document.getElementById('btnToggle').onclick = () => {
    if (!isPlaying) {
      audio.src = `audio/${encodeURIComponent(drills[activeIndex].file)}`;
      audio.play(); isPlaying = true;
      document.getElementById('statusText').textContent = 'PLAY';
      document.getElementById('statusPill').className = 'pill ok';
      document.getElementById('btnToggle').textContent = 'Stop';
      document.getElementById('btnToggle').classList.add('stop');
      hlTimer = setInterval(highlightBar, 50);
    } else {
      audio.pause(); audio.currentTime = 0; isPlaying = false;
      document.getElementById('statusText').textContent = 'STOP';
      document.getElementById('statusPill').className = 'pill stop';
      document.getElementById('btnToggle').textContent = 'Start';
      document.getElementById('btnToggle').classList.remove('stop');
      clearInterval(hlTimer);
      document.querySelectorAll('.cell').forEach(c => c.classList.remove('activeBar'));
    }
  };

  drillSelect.onchange = () => { activeIndex = +drillSelect.value; renderSelected(); if(isPlaying) document.getElementById('btnToggle').click(); };
  document.getElementById('toggleCaution').onchange = renderSelected;
  document.getElementById('toggleModes').onchange = renderSelected;
  document.getElementById('blockPanel').onchange = () => drawFretboard(drills[activeIndex].modes[0], drills[activeIndex].caution);
  window.onkeydown = (e) => { if(e.code==='Space' && e.target.tagName!=='SELECT') { e.preventDefault(); document.getElementById('btnToggle').click(); } };
  renderSelected();
})();
</script>
</body>
</html>