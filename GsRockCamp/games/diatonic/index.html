<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diatonic Chord Quiz</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --pill:#f6f7fb;
      --on:#1d4ed8;
      --warn:#b91c1c;
    }
    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:160px;
      line-height:1.35;
    }
    .wrap{ max-width:900px; margin:0 auto; }

    h1{
      font-size:22px;
      margin: 6px 0 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .ver{ font-size:12px; color:var(--muted); font-weight:900; }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    .blocks{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .blk{
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--pill);
      padding:12px;
    }
    .blkTop{
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .blkName{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .row{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .rowLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .rowRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .tbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      min-width:140px;
    }
    .tbtn:active{ transform: translateY(1px); }
    .tbtn.on{
      border-color: var(--on);
      box-shadow: 0 0 0 2px rgba(29,78,216,.12) inset;
    }
    .tbtn small{
      font-weight:900;
      color:var(--muted);
      font-size:12px;
    }

    .oct{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      font-weight:900;
      min-width:76px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .oct:active{ transform: translateY(1px); }
    .oct.on{
      border-color: var(--on);
      box-shadow: 0 0 0 2px rgba(29,78,216,.12) inset;
    }
    .oct.disabled, .tbtn.disabled{
      opacity:.35;
      pointer-events:none;
    }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    button{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{ opacity:.45; }

    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{ margin-top:12px; font-weight:900; }
    .status.warn{ color: var(--warn); }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
    }

    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{ color: var(--on); }

    .choicesGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .choice{
      padding:14px 12px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      white-space:nowrap;
    }

    .backwrap{ margin-top:12px; }
    a.backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    a.backbtn:active{ transform: translateY(1px); }

    @media (max-width: 520px){
      body{ margin:12px; }
      .tbtn{ min-width: 46%; flex:1 1 46%; }
      .blkName{ white-space:normal; overflow:visible; text-overflow:clip; }
      .oct{ min-width: 34%; flex:1 1 34%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      Diatonic Chord Quiz
      <span class="ver" id="verText">ver-</span>
    </h1>

    <div class="box">
      <div class="blocks">

        <div class="blk" data-block="easy">
          <div class="blkTop"><div class="blkName">① Easy：基本ダイアトニック（3和音）</div></div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn on" data-role="active" data-block="easy">アクティブ <small>ON</small></div>
            </div>
            <div class="rowRight">
              <div class="oct" data-role="octDown" data-row="root" data-block="easy">●Oct-</div>
              <div class="oct" data-role="octUp"   data-row="root" data-block="easy">●Oct+</div>
            </div>
          </div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn disabled" data-role="inv" data-block="easy">転回形 <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="inv" data-block="easy">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="inv" data-block="easy">●Oct+</div>
            </div>
          </div>
        </div>

        <div class="blk" data-block="normal">
          <div class="blkTop"><div class="blkName">② Normal：ダイアトニック4和音（7th系）</div></div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn" data-role="active" data-block="normal">アクティブ <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="root" data-block="normal">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="root" data-block="normal">●Oct+</div>
            </div>
          </div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn disabled" data-role="inv" data-block="normal">転回形 <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="inv" data-block="normal">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="inv" data-block="normal">●Oct+</div>
            </div>
          </div>
        </div>

        <div class="blk" data-block="plus">
          <div class="blkTop"><div class="blkName">③ Plus：セカンダリー系</div></div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn" data-role="active" data-block="plus">アクティブ <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="root" data-block="plus">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="root" data-block="plus">●Oct+</div>
            </div>
          </div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn disabled" data-role="inv" data-block="plus">転回形 <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="inv" data-block="plus">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="inv" data-block="plus">●Oct+</div>
            </div>
          </div>
        </div>

        <div class="blk" data-block="hard">
          <div class="blkTop"><div class="blkName">④ Hard：その他高度な代理</div></div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn" data-role="active" data-block="hard">アクティブ <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="root" data-block="hard">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="root" data-block="hard">●Oct+</div>
            </div>
          </div>

          <div class="row">
            <div class="rowLeft">
              <div class="tbtn disabled" data-role="inv" data-block="hard">転回形 <small>OFF</small></div>
            </div>
            <div class="rowRight">
              <div class="oct disabled" data-role="octDown" data-row="inv" data-block="hard">●Oct-</div>
              <div class="oct disabled" data-role="octUp"   data-row="inv" data-block="hard">●Oct+</div>
            </div>
          </div>
        </div>

      </div>

      <div class="btnRow">
        <button id="btnReveal" disabled>答え</button>
        <button id="btnHint" disabled>ヒント</button>
        <button id="btnC" disabled>C（基準音）</button>
      </div>

      <div class="btnRow">
        <button id="btnStart">出題</button>
        <button id="btnReplay" disabled>もう一回</button>
      </div>

      <div id="status" class="status">待機中</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <div class="box">
      <div class="scorebar">
        <div>スコア： <span id="score">0</span>/<span id="total">0</span></div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <div class="box">
      <div style="font-weight:900;">答え</div>
      <div class="choicesGrid" id="choices"></div>
    </div>

    <div class="backwrap">
      <a class="backbtn" href="../../index.html">← ポータルに戻る</a>
    </div>

    <audio id="player" preload="auto" playsinline></audio>
  </div>

  <script>
  (() => {
    // ===== versions =====
    const APP_VER   = "1.2.5";
    const AUDIO_VER = APP_VER;

    // audio path: GsRockCamp/games/diatonic/audio
    const AUDIO_BASE = "audio/";

    // show version
    const verEl = document.getElementById("verText");
    if (verEl) verEl.textContent = "ver" + APP_VER;
    document.title = "Diatonic Chord Quiz ver" + APP_VER;

    // ===== settings =====
    // Oct flags are "mix-in": _3 is ALWAYS included. Oct- adds _2, Oct+ adds _4.
    const blocks = {
      easy:   { active:true,  inv:false, octRoot:{down:false,up:false}, octInv:{down:false,up:false} },
      normal: { active:false, inv:false, octRoot:{down:false,up:false}, octInv:{down:false,up:false} },
      plus:   { active:false, inv:false, octRoot:{down:false,up:false}, octInv:{down:false,up:false} },
      hard:   { active:false, inv:false, octRoot:{down:false,up:false}, octInv:{down:false,up:false} },
    };

    // ===== voicing tables =====
    const TRIAD_V = {
      C:    { root:"C-E-G-C",    inv1:"E-G-C-E",    inv2:"G-C-E-G" },
      Dm:   { root:"D-F-A-D",    inv1:"F-A-D-F",    inv2:"A-D-F-A" },
      Em:   { root:"E-G-B-E",    inv1:"G-B-E-G",    inv2:"B-E-G-B" },
      F:    { root:"F-A-C-F",    inv1:"A-C-F-A",    inv2:"C-F-A-C" },
      G:    { root:"G-B-D-G",    inv1:"B-D-G-B",    inv2:"D-G-B-D" },
      Am:   { root:"A-C-E-A",    inv1:"C-E-A-C",    inv2:"E-A-C-E" },
      "Bm-5":{ root:"B-D-F-B",   inv1:"D-F-B-D",    inv2:"F-B-D-F" },

      Fm:   { root:"F-A♭-C-F",   inv1:"A♭-C-F-A♭",  inv2:"C-F-A♭-C" },
      Ab:   { root:"A♭-C-E♭-A♭", inv1:"C-E♭-A♭-C",  inv2:"E♭-A♭-C-E♭" },
      Bb:   { root:"B♭-D-F-B♭",  inv1:"D-F-B♭-D",   inv2:"F-B♭-D-F" },
      Eb:   { root:"E♭-G-B♭-E♭", inv1:"G-B♭-E♭-G",  inv2:"B♭-E♭-G-B♭" },
      Gm:   { root:"G-B♭-D-G",   inv1:"B♭-D-G-B♭",  inv2:"D-G-B♭-D" },
      "F#dim":{ root:"F#-A-C-F#",inv1:"A-C-F#-A",   inv2:"C-F#-A-C" },
    };

    const SEVENTH_V = {
      CM7:   { root:"C-E-G-B",   inv1:"E-G-B-C",   inv2:"G-B-C-E",   inv3:"B-C-E-G" },
      Dm7:   { root:"D-F-A-C",   inv1:"F-A-C-D",   inv2:"A-C-D-F",   inv3:"C-D-F-A" },
      Em7:   { root:"E-G-B-D",   inv1:"G-B-D-E",   inv2:"B-D-E-G",   inv3:"D-E-G-B" },
      FM7:   { root:"F-A-C-E",   inv1:"A-C-E-F",   inv2:"C-E-F-A",   inv3:"E-F-A-C" },
      G7:    { root:"G-B-D-F",   inv1:"B-D-F-G",   inv2:"D-F-G-B",   inv3:"F-G-B-D" },
      Am7:   { root:"A-C-E-G",   inv1:"C-E-G-A",   inv2:"E-G-A-C",   inv3:"G-A-C-E" },
      "Bm7-5":{root:"B-D-F-A",   inv1:"D-F-A-B",   inv2:"F-A-B-D",   inv3:"A-B-D-F" },

      E7:    { root:"E-G#-B-D",  inv1:"G#-B-D-E",  inv2:"B-D-E-G#",  inv3:"D-E-G#-B" },
      A7:    { root:"A-C#-E-G",  inv1:"C#-E-G-A",  inv2:"E-G-A-C#",  inv3:"G-A-C#-E" },
      D7:    { root:"D-F#-A-C",  inv1:"F#-A-C-D",  inv2:"A-C-D-F#",  inv3:"C-D-F#-A" },
      C7:    { root:"C-E-G-B♭",  inv1:"E-G-B♭-C",  inv2:"G-B♭-C-E",  inv3:"B♭-C-E-G" },
      Db7:   { root:"D♭-F-A♭-C♭",inv1:"F-A♭-C♭-D♭",inv2:"A♭-C♭-D♭-F",inv3:"C♭-D♭-F-A♭" },

      "G#dim7":{ root:"G#-B-D-F", inv1:"B-D-F-G#", inv2:"D-F-G#-B", inv3:"F-G#-B-D" },
    };

    // ===== items =====
    // Files may be given WITHOUT _2/_3/_4 suffix (recommended).
    // If they already include suffix, it will be normalized and replaced by chosen octave.
    const ITEMS = [
      { id:"C",    label:"C",    group:"easy",   files_root:["C.mp3"],    files_inv:["C.mp3","C_inv1.mp3","C_inv2.mp3"] },
      { id:"Dm",   label:"Dm",   group:"easy",   files_root:["Dm.mp3"],   files_inv:["Dm.mp3","Dm_inv1.mp3","Dm_inv2.mp3"] },
      { id:"Em",   label:"Em",   group:"easy",   files_root:["Em.mp3"],   files_inv:["Em.mp3","Em_inv1.mp3","Em_inv2.mp3"] },
      { id:"F",    label:"F",    group:"easy",   files_root:["F.mp3"],    files_inv:["F.mp3","F_inv1.mp3","F_inv2.mp3"] },
      { id:"G",    label:"G",    group:"easy",   files_root:["G.mp3"],    files_inv:["G.mp3","G_inv1.mp3","G_inv2.mp3"] },
      { id:"Am",   label:"Am",   group:"easy",   files_root:["Am.mp3"],   files_inv:["Am.mp3","Am_inv1.mp3","Am_inv2.mp3"] },
      { id:"Bm-5", label:"Bm-5", group:"easy",   files_root:["Bm-5.mp3"], files_inv:["Bm-5.mp3","Bm-5_inv1.mp3","Bm-5_inv2.mp3"] },

      { id:"CM7",   label:"CM7",   group:"normal", files_root:["CM7.mp3"],   files_inv:["CM7.mp3","CM7_inv1.mp3","CM7_inv2.mp3","CM7_inv3.mp3"] },
      { id:"Dm7",   label:"Dm7",   group:"normal", files_root:["Dm7.mp3"],   files_inv:["Dm7.mp3","Dm7_inv1.mp3","Dm7_inv2.mp3","Dm7_inv3.mp3"] },
      { id:"Em7",   label:"Em7",   group:"normal", files_root:["Em7.mp3"],   files_inv:["Em7.mp3","Em7_inv1.mp3","Em7_inv2.mp3","Em7_inv3.mp3"] },
      { id:"FM7",   label:"FM7",   group:"normal", files_root:["FM7.mp3"],   files_inv:["FM7.mp3","FM7_inv1.mp3","FM7_inv2.mp3","FM7_inv3.mp3"] },
      { id:"G7",    label:"G7",    group:"normal", files_root:["G7.mp3"],    files_inv:["G7.mp3","G7_inv1.mp3","G7_inv2.mp3","G7_inv3.mp3"] },
      { id:"Am7",   label:"Am7",   group:"normal", files_root:["Am7.mp3"],   files_inv:["Am7.mp3","Am7_inv1.mp3","Am7_inv2.mp3","Am7_inv3.mp3"] },
      { id:"Bm7-5", label:"Bm7-5", group:"normal", files_root:["Bm7-5.mp3"], files_inv:["Bm7-5.mp3","Bm7-5_inv1.mp3","Bm7-5_inv2.mp3","Bm7-5_inv3.mp3"] },

      { id:"E7",   label:"E7",   group:"plus", files_root:["E7.mp3"],  files_inv:[] },
      { id:"A7",   label:"A7",   group:"plus", files_root:["A7.mp3"],  files_inv:[] },
      { id:"D7",   label:"D7",   group:"plus", files_root:["D7.mp3"],  files_inv:[] },
      { id:"C7",   label:"C7",   group:"plus", files_root:["C7.mp3"],  files_inv:[] },
      { id:"Db7",  label:"D♭7",  group:"plus", files_root:["Db7.mp3"], files_inv:[] },

      { id:"Fm",     label:"Fm",     group:"hard", files_root:["Fm.mp3"],     files_inv:[] },
      { id:"Ab",     label:"A♭",     group:"hard", files_root:["Ab.mp3"],     files_inv:[] },
      { id:"Bb",     label:"B♭",     group:"hard", files_root:["Bb.mp3"],     files_inv:[] },
      { id:"Eb",     label:"E♭",     group:"hard", files_root:["Eb.mp3"],     files_inv:[] },
      { id:"Gm",     label:"Gm",     group:"hard", files_root:["Gm.mp3"],     files_inv:[] },
      { id:"F#dim",  label:"F#dim",  group:"hard", files_root:["F#dim.mp3"],  files_inv:[] },
      { id:"G#dim7", label:"G#dim7", group:"hard", files_root:["G#dim7.mp3"], files_inv:[] },
    ];

    const byId = new Map(ITEMS.map(x => [x.id, x]));

    // ===== DOM =====
    let player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hintArea = document.getElementById("hintArea");

    const scoreEl  = document.getElementById("score");
    const totalEl  = document.getElementById("total");
    const accuracyEl = document.getElementById("accuracy");

    const btnStart = document.getElementById("btnStart");
    const btnReplay= document.getElementById("btnReplay");
    const btnReveal= document.getElementById("btnReveal");
    const btnHint  = document.getElementById("btnHint");
    const btnC     = document.getElementById("btnC");
    const choicesWrap = document.getElementById("choices");

    // ===== state =====
    let phase = "idle"; // idle | answering | retryPrompt
    let current = null; // { id,label,fileBase,fileActual,group,voicingText,invName }
    let score = 0;
    let total = 0;

    function setStatus(text, warn=false){
      statusEl.textContent = text;
      statusEl.classList.toggle("warn", !!warn);
    }
    function clearHint(){
      hintArea.style.display = "none";
      hintArea.textContent = "";
    }
    function setHint(text){
      hintArea.style.display = "block";
      hintArea.textContent = text;
    }
    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round((score / total) * 100);
      const accText = String(acc).padStart(2, "0") + "%";
      accuracyEl.textContent = `正答率 ${accText}`;
      accuracyEl.classList.toggle("good", acc >= 80);
    }
    function setAnswerControls(enabled){
      btnReplay.disabled = !enabled;
      btnReveal.disabled = !enabled;
      btnHint.disabled   = !enabled;
      btnC.disabled      = !enabled;
    }
    function setChoicesEnabled(enabled){
      Array.from(document.querySelectorAll(".choice")).forEach(b => b.disabled = !enabled);
    }
    function resetToIdle(msg){
      phase = "idle";
      current = null;
      clearHint();
      setAnswerControls(false);
      setChoicesEnabled(false);
      btnStart.disabled = false;
      setStatus(msg ?? "待機中");
    }

    // ===== audio helpers =====
    function normalizeFileBase(file){
      // remove _2/_3/_4 before .mp3 if already present
      return file.replace(/_([234])\.mp3$/i, ".mp3");
    }
    function withOct(fileBase, oct){
      const base = normalizeFileBase(fileBase);
      return base.replace(/\.mp3$/i, `_${oct}.mp3`);
    }
    function buildSrc(file){
      const url = encodeURI(AUDIO_BASE + file);
      return url + "?v=" + encodeURIComponent(AUDIO_VER);
    }

    function waitPlayable(el, timeoutMs){
      return new Promise((resolve, reject) => {
        let done = false;
        const ok = () => {
          if (done) return;
          done = true;
          cleanup();
          resolve();
        };
        const ng = () => {
          if (done) return;
          done = true;
          cleanup();
          const code = el && el.error ? el.error.code : "unknown";
          reject(new Error("audio_error_code_" + code));
        };
        const t = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          resolve();
        }, timeoutMs);

        function cleanup(){
          clearTimeout(t);
          el.removeEventListener("canplay", ok);
          el.removeEventListener("loadeddata", ok);
          el.removeEventListener("canplaythrough", ok);
          el.removeEventListener("error", ng);
          el.removeEventListener("stalled", ng);
          el.removeEventListener("abort", ng);
        }

        el.addEventListener("canplay", ok, { once:true });
        el.addEventListener("loadeddata", ok, { once:true });
        el.addEventListener("canplaythrough", ok, { once:true });
        el.addEventListener("error", ng, { once:true });
        el.addEventListener("stalled", ng, { once:true });
        el.addEventListener("abort", ng, { once:true });
      });
    }

    function rebuildPlayerElement(){
      try{ player.pause(); }catch(e){}
      const old = player;
      const neu = document.createElement("audio");
      neu.id = "player";
      neu.preload = "auto";
      neu.setAttribute("playsinline", "");
      old.parentNode.replaceChild(neu, old);
      player = neu;
    }

    async function playFile(actualFile){
      const src = buildSrc(actualFile);

      try{ player.pause(); }catch(e){}
      try{ player.currentTime = 0; }catch(e){}
      player.muted = false;
      player.volume = 1;

      try{
        player.removeAttribute("src");
        player.load();
      }catch(e){}

      player.src = src;
      player.load();

      await waitPlayable(player, 2500);

      try{
        await player.play();
      }catch(err){
        rebuildPlayerElement();
        player.src = src;
        player.load();
        await waitPlayable(player, 2500);
        await player.play();
      }
    }

    // ===== selection pools =====
    function activeGroups(){
      return Object.keys(blocks).filter(k => blocks[k].active);
    }
    function idsForActiveGroups(){
      const gs = new Set(activeGroups());
      const ids = [];
      for (const it of ITEMS){
        if (gs.has(it.group)) ids.push(it.id);
      }
      return ids;
    }

    function safeFiles(item, wantInv){
      const root = Array.isArray(item.files_root) && item.files_root.length ? item.files_root : [];
      const inv  = Array.isArray(item.files_inv)  && item.files_inv.length  ? item.files_inv  : [];
      if (wantInv && inv.length) return inv;
      return root.length ? root : inv;
    }

    function voicingForFile(itemId, fileBase){
      const tv = TRIAD_V[itemId];
      if (tv){
        if (fileBase.includes("_inv1")) return { v: tv.inv1, invName: "第一転回形" };
        if (fileBase.includes("_inv2")) return { v: tv.inv2, invName: "第二転回形" };
        return { v: tv.root, invName: "ルート" };
      }

      const sv = SEVENTH_V[itemId];
      if (sv){
        if (fileBase.includes("_inv1")) return { v: sv.inv1 ?? sv.root, invName: "第一転回形" };
        if (fileBase.includes("_inv2")) return { v: sv.inv2 ?? sv.root, invName: "第二転回形" };
        if (fileBase.includes("_inv3")) return { v: sv.inv3 ?? sv.root, invName: "第三転回形" };
        return { v: sv.root, invName: "ルート" };
      }

      return { v: "", invName: "" };
    }

    function allowedOctavesForRow(blockKey, rowKey){
      // rowKey: "root" | "inv"
      // ALWAYS include 3
      const cfg = blocks[blockKey];
      const flags = (rowKey === "inv") ? cfg.octInv : cfg.octRoot;
      const list = [3];
      if (flags.down) list.push(2);
      if (flags.up)   list.push(4);
      // stable order: [3,2,4] -> but random pick anyway; sort for readability
      const uniq = Array.from(new Set(list));
      return uniq;
    }

    function pickQuestion(){
      const gs = activeGroups();
      if (gs.length === 0) return null;

      const group = gs[Math.floor(Math.random() * gs.length)];
      const candidates = ITEMS.filter(x => x.group === group);
      if (!candidates.length) return null;

      const item = candidates[Math.floor(Math.random() * candidates.length)];
      const wantInv = !!blocks[group].inv;

      const files = safeFiles(item, wantInv);
      if (!files || !files.length) return null;

      // choose file base (no octave yet)
      const fileBase = normalizeFileBase(files[Math.floor(Math.random() * files.length)]);

      // decide row by fileBase itself
      const rowKey = fileBase.includes("_inv") ? "inv" : "root";

      // choose octave from allowed set (always includes 3)
      const octs = allowedOctavesForRow(group, rowKey);
      const oct = octs[Math.floor(Math.random() * octs.length)];

      const fileActual = withOct(fileBase, oct);

      const vx = voicingForFile(item.id, fileBase);

      return {
        id: item.id,
        label: item.label,
        fileBase,
        fileActual,
        group,
        rowKey,
        voicingText: vx.v,
        invName: vx.invName
      };
    }

    // ===== UI render =====
    function renderButtons(){
      // toggles
      document.querySelectorAll(".tbtn").forEach(el => {
        const role = el.dataset.role;
        const blk = el.dataset.block;

        if (role === "active"){
          const on = blocks[blk].active;
          el.classList.toggle("on", !!on);
          const sm = el.querySelector("small");
          if (sm) sm.textContent = on ? "ON" : "OFF";
          el.classList.remove("disabled");
          return;
        }

        if (role === "inv"){
          const enabledByActive = blocks[blk].active;
          const on = blocks[blk].inv;
          el.classList.toggle("on", !!on);
          const sm = el.querySelector("small");
          if (sm) sm.textContent = on ? "ON" : "OFF";
          el.classList.toggle("disabled", !enabledByActive);
          return;
        }
      });

      // oct buttons
      document.querySelectorAll(".oct").forEach(el => {
        const blk = el.dataset.block;
        const row = el.dataset.row; // root/inv
        const role = el.dataset.role; // octDown/octUp

        const cfg = blocks[blk];
        const enabledBlock = cfg.active;
        const enabledRow = (row === "root") ? cfg.active : (cfg.active && cfg.inv);

        // state
        const flags = (row === "inv") ? cfg.octInv : cfg.octRoot;
        const isOn = (role === "octDown") ? flags.down : flags.up;

        el.classList.toggle("on", !!isOn);
        el.classList.toggle("disabled", !(enabledBlock && enabledRow));
      });
    }

    function rebuildChoices(){
      const ids = idsForActiveGroups();
      choicesWrap.innerHTML = "";

      ids.forEach(id => {
        const item = byId.get(id);
        if (!item) return;

        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = item.label;
        b.dataset.id = item.id;
        b.disabled = true;

        b.addEventListener("click", () => {
          if (phase !== "answering" || !current) return;

          const guess = b.dataset.id;

          if (guess === current.id){
            total += 1;
            score += 1;
            totalEl.textContent = String(total);
            scoreEl.textContent = String(score);
            updateAccuracy();

            setStatus(`${current.label} 正解!（${current.voicingText} ${current.invName}）`);
            phase = "idle";
            current = null;

            setChoicesEnabled(false);
            setAnswerControls(false);
            btnStart.disabled = false;
          } else {
            // NOT counted yet
            phase = "retryPrompt";
            setStatus("不正解…（もう一回 / 答え / 出題＝スキップ）", true);

            setChoicesEnabled(false);
            setAnswerControls(true);
            btnStart.disabled = false;
          }
        });

        choicesWrap.appendChild(b);
      });

      if (ids.length === 0){
        setStatus("出題が全部OFFです。", true);
      }
    }

    // ===== interactions =====
    // active / inv
    document.querySelectorAll(".tbtn").forEach(el => {
      el.addEventListener("click", () => {
        const role = el.dataset.role;
        const blk = el.dataset.block;

        if (role === "active"){
          blocks[blk].active = !blocks[blk].active;

          // if turning OFF, also force inv OFF
          if (!blocks[blk].active){
            blocks[blk].inv = false;
          }

          if (phase !== "idle") resetToIdle("設定を変更しました。");
          rebuildChoices();
          renderButtons();
          return;
        }

        if (role === "inv"){
          if (!blocks[blk].active) return;
          blocks[blk].inv = !blocks[blk].inv;

          if (!blocks[blk].inv){
            // keep oct flags (mix) as-is, but row becomes disabled; state preserved
          }

          if (phase !== "idle") resetToIdle("設定を変更しました。");
          renderButtons();
          setStatus("設定を変更しました。");
          return;
        }
      });
    });

    // oct buttons
    document.querySelectorAll(".oct").forEach(el => {
      el.addEventListener("click", () => {
        const blk = el.dataset.block;
        const row = el.dataset.row; // root/inv
        const role = el.dataset.role; // octDown/octUp

        const cfg = blocks[blk];

        // block must be active
        if (!cfg.active) return;

        // row must be enabled
        if (row === "inv" && !cfg.inv) return;

        const flags = (row === "inv") ? cfg.octInv : cfg.octRoot;

        if (role === "octDown") flags.down = !flags.down;
        if (role === "octUp")   flags.up   = !flags.up;

        if (phase !== "idle") resetToIdle("設定を変更しました。");
        renderButtons();
      });
    });

    // buttons
    btnStart.addEventListener("click", async () => {
      // in retryPrompt: "skip"
      if (phase === "retryPrompt" && current){
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`${current.label} スキップ（${current.voicingText} ${current.invName}）`);
        phase = "idle";
        current = null;

        setAnswerControls(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
        return;
      }

      if (phase !== "idle") return;

      const ids = idsForActiveGroups();
      if (ids.length === 0){
        setStatus("出題が全部OFFです。", true);
        return;
      }

      current = pickQuestion();
      if (!current){
        setStatus("出題できません（音源名/配置を確認）", true);
        current = null;
        return;
      }

      clearHint();
      setStatus("出題中");
      phase = "answering";

      btnStart.disabled = true;
      setAnswerControls(true);
      setChoicesEnabled(true);

      try{
        await playFile(current.fileActual);
      }catch(e){
        setStatus(`再生失敗：${current.fileActual}`, true);
      }
    });

    btnReplay.addEventListener("click", async () => {
      if (!current) return;
      clearHint();

      if (phase === "retryPrompt"){
        // retry does NOT count total
        setStatus("再挑戦");
        phase = "answering";
        btnStart.disabled = true;
        setChoicesEnabled(true);
      } else {
        setStatus("もう一回");
      }

      try{
        await playFile(current.fileActual); // same file, same octave
      }catch(e){
        setStatus(`再生失敗：${current.fileActual}`, true);
      }
    });

    btnReveal.addEventListener("click", () => {
      if (!current) return;

      if (phase === "retryPrompt"){
        // finalize as incorrect
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`${current.label}（${current.voicingText} ${current.invName}）`);
        phase = "idle";
        current = null;

        setAnswerControls(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
      } else {
        setStatus(`${current.label}（${current.voicingText} ${current.invName}）`);
      }
    });

    btnHint.addEventListener("click", () => {
      if (!current) return;
      setHint("（なし）");
    });

    btnC.addEventListener("click", async () => {
      // fixed reference tone: C_3
      const f = withOct("C.mp3", 3);
      try{
        await playFile(f);
        setStatus("C（基準音）");
      }catch(e){
        setStatus(`Cを再生できません（${f}）`, true);
      }
    });

    // init
    scoreEl.textContent = "0";
    totalEl.textContent = "0";
    updateAccuracy();
    rebuildChoices();
    renderButtons();
    resetToIdle("待機中");
  })();
  </script>
</body>
</html>
