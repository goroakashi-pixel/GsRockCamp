<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diatonic Chord Quiz</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --blue:#1d4ed8;
      --warn:#b91c1c;
      --pill:#f6f7fb;
    }

    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:140px;
      line-height:1.35;
    }
    .wrap{ max-width:860px; margin:0 auto; }

    h1{
      font-size:22px;
      margin: 6px 0 12px;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .ver{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    .muted{ color: var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }

    .groupTitle{
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .radioStack{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* “ラベル全体をタップ”用 */
    .radioTile{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--pill);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .radioTile:active{ transform: translateY(1px); }
    .radioTile input{
      transform:scale(1.25);
      accent-color: var(--blue);
    }
    .radioMain{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .radioMain b{ font-weight:900; }
    .radioSub{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .radioTile.disabled{
      opacity:.55;
      background:#fafafa;
    }
    .radioTile.disabled input{
      accent-color:#999;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    button{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{ opacity:.45; }

    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{ margin-top:12px; font-weight:900; }
    .status.warn{ color: var(--warn); }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
    }

    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{ color: var(--blue); }

    .choicesGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .choice{
      white-space:nowrap;
      padding:14px 12px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }

    /* back bottom */
    .grc-backwrap{ margin-top: 12px; }
    a.grc-backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    a.grc-backbtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      Diatonic Chord Quiz
      <span class="ver">ver1.2</span>
    </h1>

    <!-- 設定（2軸ラジオ） -->
    <div class="box">
      <div class="muted">選択肢は増やさず、揺らぎだけを増やす。</div>

      <div class="grid2">
        <div>
          <div class="groupTitle">出題セット <span class="muted" style="font-size:12px;">（単一選択）</span></div>
          <div class="radioStack" id="setRadios">
            <label class="radioTile">
              <input type="radio" name="qset" value="basic" checked>
              <div class="radioMain">
                <b>① 基本ダイアトニック</b>
                <div class="radioSub">まずはここ。C / Dm / Em / F / G / Am / Bm-5</div>
              </div>
            </label>

            <!-- ②③は将来拡張：UIだけ置く（現時点では無効） -->
            <label class="radioTile disabled" title="準備中">
              <input type="radio" name="qset" value="plus" disabled>
              <div class="radioMain">
                <b>② A7などプラス（セカンダリー／借用系）</b>
                <div class="radioSub">準備中（音源拡張後にON）</div>
              </div>
            </label>

            <label class="radioTile disabled" title="準備中">
              <input type="radio" name="qset" value="evil" disabled>
              <div class="radioMain">
                <b>③ 意地悪モード（紛らわしい・近似系）</b>
                <div class="radioSub">準備中（音源拡張後にON）</div>
              </div>
            </label>
          </div>
        </div>

        <div>
          <div class="groupTitle">転回形 <span class="muted" style="font-size:12px;">（単一選択）</span></div>
          <div class="radioStack" id="invRadios">
            <label class="radioTile">
              <input type="radio" name="inv" value="root" checked>
              <div class="radioMain">
                <b>無（ルートのみ）</b>
                <div class="radioSub">常に root を再生</div>
              </div>
            </label>

            <label class="radioTile">
              <input type="radio" name="inv" value="mix">
              <div class="radioMain">
                <b>有（ルート＋転回形を混在）</b>
                <div class="radioSub">root / 1st / 2nd をランダム（未整備はrootへ自動フォールバック）</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="btnStart">出題</button>
        <button id="btnReplay" disabled>もう一回</button>
        <button id="btnReveal" disabled>答え</button>
        <button id="btnHint" disabled>ヒント</button>
        <button id="btnC" disabled>C（基準音）</button>
      </div>

      <div id="status" class="status">まだ出題していません</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <!-- 選択肢 -->
    <div class="box">
      <div style="font-weight:900;">答えを選んでください</div>
      <div class="choicesGrid" id="choices"></div>
    </div>

    <!-- スコア -->
    <div class="box">
      <div class="scorebar">
        <div>スコア： <span id="score">0</span>/<span id="total">0</span></div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <div class="grc-backwrap">
      <a class="grc-backbtn" href="./index.html">← ポータルに戻る</a>
    </div>

    <audio id="player" preload="auto"></audio>
  </div>

  <script>
  (() => {
    // =========================
    // ここだけ最初に調整OK
    // =========================
    const AUDIO_VER  = "v2";                 // キャッシュ対策（更新したら文字列変える）
    const AUDIO_BASE = "diatonic/audio/"; // 例）ルートから：audio/diatonic/v2/
                                              // 例）1階層下なら：../audio/diatonic/v2/

    // =========================
    // データ：id（判定）と file（再生）を分離
    // =========================
    const CHORDS = [
      // --- ① 基本ダイアトニック（7つ）---
      { id:"C",    label:"C",    files_root:["C.mp3"],    files_inv:["C.mp3","C_inv1.mp3","C_inv2.mp3"],    hint:"キャラ：Cメジャー三和音（C–E–G）" },
      { id:"Dm",   label:"Dm",   files_root:["Dm.mp3"],   files_inv:["Dm.mp3","Dm_inv1.mp3","Dm_inv2.mp3"], hint:"キャラ：マイナー三和音（D–F–A）" },
      { id:"Em",   label:"Em",   files_root:["Em.mp3"],   files_inv:["Em.mp3","Em_inv1.mp3","Em_inv2.mp3"], hint:"キャラ：マイナー三和音（E–G–B）" },
      { id:"F",    label:"F",    files_root:["F.mp3"],    files_inv:["F.mp3","F_inv1.mp3","F_inv2.mp3"],    hint:"キャラ：メジャー三和音（F–A–C）" },
      { id:"G",    label:"G",    files_root:["G.mp3"],    files_inv:["G.mp3","G_inv1.mp3","G_inv2.mp3"],    hint:"キャラ：メジャー三和音（G–B–D）" },
      { id:"Am",   label:"Am",   files_root:["Am.mp3"],   files_inv:["Am.mp3","Am_inv1.mp3","Am_inv2.mp3"], hint:"キャラ：マイナー三和音（A–C–E）" },
      { id:"Bm-5", label:"Bm-5", files_root:["Bm-5.mp3"], files_inv:["Bm-5.mp3","Bm-5_inv1.mp3","Bm-5_inv2.mp3"], hint:"キャラ：減三和音（B–D–F）※不安定" },

      // --- ②③（将来拡張）※現時点ではrootのみ想定（files_inv未整備でも安全フォールバックする）---
      { id:"CM7",   label:"CM7",   files_root:["CM7.mp3"],   hint:"キャラ：M7（B）※半音で上に寄る感じ" },
      { id:"Dm7",   label:"Dm7",   files_root:["Dm7.mp3"],   hint:"キャラ：m7（C）※4音で少しジャズ化" },
      { id:"Em7",   label:"Em7",   files_root:["Em7.mp3"],   hint:"キャラ：m7（D）" },
      { id:"FM7",   label:"FM7",   files_root:["FM7.mp3"],   hint:"キャラ：M7（E）" },
      { id:"G7",    label:"G7",    files_root:["G7.mp3"],    hint:"キャラ：7（F）※ドミナントの圧" },
      { id:"Am7",   label:"Am7",   files_root:["Am7.mp3"],   hint:"キャラ：m7（G）" },
      { id:"Bm7-5", label:"Bm7-5", files_root:["Bm7-5.mp3"], hint:"キャラ：m7♭5（A）※半減の匂い" },

      { id:"E7",  label:"E7",  files_root:["E7.mp3"],  hint:"キャラ：G#（長3度）※急に外の音が立つ" },
      { id:"A7",  label:"A7",  files_root:["A7.mp3"],  hint:"キャラ：C#（長3度）※外音で圧が出る" },
      { id:"D7",  label:"D7",  files_root:["D7.mp3"],  hint:"キャラ：F#（長3度）※外音で圧が出る" },
      { id:"C7",  label:"C7",  files_root:["C7.mp3"],  hint:"キャラ：Bb（♭7）※ブルース/ドミナント化" },
      { id:"Db7", label:"Db7", files_root:["Db7.mp3"], hint:"キャラ：トライトーン感（代理ドミナントっぽい圧）" },

      { id:"Fm",     label:"Fm",     files_root:["Fm.mp3"],     hint:"キャラ：Ab（♭3）※サブドミナントマイナー系の匂い" },
      { id:"Ab",     label:"Ab",     files_root:["Ab.mp3"],     hint:"キャラ：Abメジャー（三和音）※借用の色" },
      { id:"Bb",     label:"Bb",     files_root:["Bb.mp3"],     hint:"キャラ：Bbメジャー（三和音）※♭VIIのロック感" },
      { id:"Eb",     label:"Eb",     files_root:["Eb.mp3"],     hint:"キャラ：Ebメジャー（三和音）※♭IIIの色" },
      { id:"Gm",     label:"Gm",     files_root:["Gm.mp3"],     hint:"キャラ：Bb（短3度）※借用マイナーの匂い" },
      { id:"F#dim",  label:"F#dim",  files_root:["F#dim.mp3"],  hint:"キャラ：F#–A–C（減）※緊張/経過" },
      { id:"G#dim7", label:"G#dim7", files_root:["G#dim7.mp3"], hint:"キャラ：短3度積み（G#→B→D→F）※意地悪枠" },
    ];

    // 出題セット（将来：plus/evilを拡張）
    const POOLS = {
      basic: ["C","Dm","Em","F","G","Am","Bm-5"],
      plus:  ["E7","A7","D7","C7","Db7"],                 // 例（準備中）
      evil:  ["Fm","Ab","Bb","Eb","Gm","F#dim","G#dim7"],  // 例（準備中）
    };

    const byId = new Map(CHORDS.map(x => [x.id, x]));

    // =========================
    // DOM
    // =========================
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hintArea = document.getElementById("hintArea");

    const scoreEl  = document.getElementById("score");
    const totalEl  = document.getElementById("total");
    const accuracyEl = document.getElementById("accuracy");

    const btnStart = document.getElementById("btnStart");
    const btnReplay= document.getElementById("btnReplay");
    const btnReveal= document.getElementById("btnReveal");
    const btnHint  = document.getElementById("btnHint");
    const btnC     = document.getElementById("btnC");

    const choicesWrap = document.getElementById("choices");

    // =========================
    // 状態（ver1.0の思想を維持）
    // phase:
    //  - idle：待機（出題可能）
    //  - answering：回答受付中
    //  - retryPrompt：不正解後の3択（もう一回 / 答え / 出題=スキップ）
    // =========================
    let phase = "idle";
    let current = null; // { id, label, hint, file }
    let score = 0;
    let total = 0;

    function getSelectedSet(){
      const el = document.querySelector('input[name="qset"]:checked');
      return el ? el.value : "basic";
    }
    function getSelectedInv(){
      const el = document.querySelector('input[name="inv"]:checked');
      return el ? el.value : "root";
    }

    function getPoolIds(){
      const setKey = getSelectedSet();
      return POOLS[setKey] ?? POOLS.basic;
    }

    function clearHint(){
      hintArea.style.display = "none";
      hintArea.textContent = "";
    }

    function setStatus(text, warn=false){
      statusEl.textContent = text;
      statusEl.classList.toggle("warn", !!warn);
    }

    function setReplayBlock(enabled){
      btnReplay.disabled = !enabled;
      btnReveal.disabled = !enabled;
      btnHint.disabled   = !enabled;
      btnC.disabled      = !enabled;
    }

    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round((score / total) * 100);
      const accText = String(acc).padStart(2, "0") + "%";
      accuracyEl.textContent = `正答率 ${accText}`;
      accuracyEl.classList.toggle("good", acc >= 80);
    }

    function buildSrc(file){
      // encodeURIで # や日本語など万一入っても安全側に倒す
      const url = encodeURI(AUDIO_BASE + file);
      return url + "?v=" + encodeURIComponent(AUDIO_VER);
    }

    async function playFile(file){
      player.pause();
      player.currentTime = 0;
      player.src = buildSrc(file);
      await player.play();
    }

    function safeFiles(ch, wantInv){
      const root = Array.isArray(ch.files_root) && ch.files_root.length ? ch.files_root : [];
      const inv  = Array.isArray(ch.files_inv)  && ch.files_inv.length  ? ch.files_inv  : [];
      if (wantInv && inv.length) return inv;
      // inv未整備でも必ずrootへフォールバック
      return root.length ? root : inv;
    }

    function pickRandomFromPool(){
      const ids = getPoolIds();
      if (!ids.length) return null;

      const id = ids[Math.floor(Math.random() * ids.length)];
      const ch = byId.get(id);
      if (!ch) return null;

      const wantInv = (getSelectedInv() === "mix");
      const files = safeFiles(ch, wantInv);
      if (!files || !files.length) return null;

      const file = files[Math.floor(Math.random() * files.length)];

      return {
        id: ch.id,
        label: ch.label,
        hint: ch.hint ?? "",
        file,
      };
    }

    function rebuildChoices(){
      // 「選択肢は増やさず」＝ 現在セットのプールだけ表示
      const poolIds = getPoolIds();
      choicesWrap.innerHTML = "";

      poolIds.forEach(id => {
        const ch = byId.get(id);
        if (!ch) return;

        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = ch.label;
        b.dataset.id = ch.id;
        b.disabled = true;

        b.addEventListener("click", () => {
          if (phase !== "answering" || !current) return;

          const guess = b.dataset.id;
          if (guess === current.id){
            // 正解確定：ここで母数を増やす
            total += 1;
            score += 1;
            totalEl.textContent = String(total);
            scoreEl.textContent = String(score);
            updateAccuracy();

            setStatus(`⭕ 正解！ ${current.label}（次の出題OK）`);
            phase = "idle";
            current = null;

            setChoicesEnabled(false);
            setReplayBlock(false);
            btnStart.disabled = false;
          }else{
            // 不正解：まだ母数に加えない／すぐ答えも出さない
            phase = "retryPrompt";
            setStatus("❌ 不正解… 再挑戦しますか？（もう一回 / 答え / 出題＝スキップ）", true);

            // 選択肢は一旦止める（再挑戦は「もう一回」から）
            setChoicesEnabled(false);

            // もう一回/答え/出題/基準音は押せる
            setReplayBlock(true);

            // 出題＝スキップも許可
            btnStart.disabled = false;
          }
        });

        choicesWrap.appendChild(b);
      });
    }

    function setChoicesEnabled(enabled){
      const btns = Array.from(document.querySelectorAll(".choice"));
      btns.forEach(b => b.disabled = !enabled);
    }

    function resetToIdle(message){
      clearHint();
      current = null;
      phase = "idle";

      setReplayBlock(false);
      setChoicesEnabled(false);
      btnStart.disabled = false;

      setStatus(message ?? "設定を変更しました。出題してください。", false);
    }

    // =========================
    // events：ラジオ変更 → 状態リセットして待機へ
    // =========================
    document.getElementById("setRadios").addEventListener("change", () => {
      rebuildChoices();
      resetToIdle("出題セットを変更しました。出題してください。");
    });

    document.getElementById("invRadios").addEventListener("change", () => {
      resetToIdle("転回形設定を変更しました。出題してください。");
    });

    // =========================
    // 出題ボタン：
    // - idle：新規出題
    // - retryPrompt：スキップ扱い（＝不正解確定として母数に加える）→ 次の問題へ
    // =========================
    btnStart.addEventListener("click", async () => {
      // retryPrompt中に押されたら＝スキップ
      if (phase === "retryPrompt" && current) {
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`スキップ：正解は ${current.label}（次の出題OK）`);
        phase = "idle";
        current = null;

        setReplayBlock(false);
        setChoicesEnabled(false);
        // ここでreturnしない：押し直しで次の出題ができるように
        return;
      }

      if (phase !== "idle") return;

      current = pickRandomFromPool();
      if (!current){
        setStatus("出題データが見つかりません（ID/音源の対応を確認してください）", true);
        return;
      }

      clearHint();
      setStatus("出題中：聴いて選んでください。");
      phase = "answering";

      // 出題中は出題ボタン無効（連打防止）
      btnStart.disabled = true;

      setReplayBlock(true);
      setChoicesEnabled(true);

      try {
        await playFile(current.file);
      } catch (e) {
        setStatus("再生できませんでした。もう一度「出題」を押してください。", true);
        phase = "idle";
        btnStart.disabled = false;
        setChoicesEnabled(false);
        setReplayBlock(false);
      }
    });

    // もう一回：
    // - answering：再生だけ（同一ファイル）
    // - retryPrompt：不正解確定として母数++ → 再挑戦へ（同一ファイル）
    btnReplay.addEventListener("click", async () => {
      if (!current) return;
      clearHint();

      if (phase === "retryPrompt") {
        // 「もう一回」を押した＝その不正解は確定で母数に入れる
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus("再挑戦：もう一回聴いて、答えを選んでください。", false);
        phase = "answering";

        // 再挑戦中は出題ボタンを無効（スキップ誤爆防止）
        btnStart.disabled = true;
        setChoicesEnabled(true);
      } else {
        setStatus("もう一回再生しました。");
      }

      try { await playFile(current.file); } catch {}
    });

    // 答え：
    // - retryPrompt：不正解確定（母数に入れる）→ 正解表示 → 次へ
    // - answering：ただ表示（採点にはしない）
    btnReveal.addEventListener("click", () => {
      if (!current) return;

      if (phase === "retryPrompt") {
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`答え：${current.label}（次の出題OK）`, false);

        phase = "idle";
        current = null;

        setReplayBlock(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
      } else {
        setStatus(`答え：${current.label}`);
      }
    });

    btnHint.addEventListener("click", () => {
      if (!current) return;
      hintArea.style.display = "block";
      hintArea.innerHTML = `<b>ヒント</b><br><code>${current.hint || "（未設定）"}</code>`;
    });

    btnC.addEventListener("click", async () => {
      try {
        await playFile("C.mp3");
        setStatus("基準音：C を再生しました。");
      } catch (e) {
        setStatus("Cの再生に失敗しました。", true);
      }
    });

    // init
    scoreEl.textContent = "0";
    totalEl.textContent = "0";
    updateAccuracy();

    rebuildChoices();
    setReplayBlock(false);
    setChoicesEnabled(false);
    btnStart.disabled = false;
  })();
  </script>
</body>
</html>
