<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diatonic Chord Quiz</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --blue:#1d4ed8;
      --warn:#b91c1c;
    }

    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:120px;
    }

    .wrap{ max-width:820px; margin:0 auto; }

    h1{
      font-size:22px;
      margin: 6px 0 12px;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .ver{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    label{
      font-weight:800;
      display:inline-block;
      margin-right:8px;
    }

    select{
      width:100%;
      padding:12px 12px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    button{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{ opacity:.45; }

    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{ margin-top:12px; font-weight:900; }
    .status.warn{ color: var(--warn); }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
    }

    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{ color: var(--blue); }

    .grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .choice{
      white-space:nowrap;
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
    }

    /* back bottom */
    .grc-backwrap{ margin-top: 12px; }
    a.grc-backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    a.grc-backbtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      Diatonic Chord Quiz
      <span class="ver">ver1.0</span>
    </h1>

    <div class="box">
      <label for="difficulty">難易度選択</label>
      <select id="difficulty">
        <option value="d1">① 3和音ダイアトニックのみ</option>
        <option value="d2">② 4和音ダイアトニックを①に加える</option>
        <option value="d3">③ ノーマル群を①に加える</option>
        <option value="d4">④ ノーマル群を②に加える</option>
        <option value="d5">⑤ 全部（意地悪枠込み）</option>
      </select>

      <div class="btn-row">
        <button id="btnStart">出題</button>
        <button id="btnReplay" disabled>もう一回</button>
        <button id="btnReveal" disabled>答え</button>
        <button id="btnHint" disabled>ヒント</button>
        <button id="btnC" disabled>C（基準音）</button>
      </div>

      <div id="status" class="status">まだ出題していません</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;">答えを選んでください</div>
      <div class="grid" id="choices"></div>
    </div>

    <div class="box">
      <div class="scorebar">
        <div>スコア： <span id="score">0</span>/<span id="total">0</span></div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <div class="grc-backwrap">
      <a class="grc-backbtn" href="../../index.html">← ポータルに戻る</a>
    </div>

    <audio id="player" preload="auto"></audio>
  </div>

  <script>
    // ===== 出題データ（※既存のファイル名をそのまま使用）=====
    const ALL = [
      { key:"C",    label:"C",    src:"audio/C.mp3",    hint:"Cメジャー三和音（C–E–G）" },
      { key:"Dm",   label:"Dm",   src:"audio/Dm.mp3",   hint:"マイナー三和音（D–F–A）" },
      { key:"Em",   label:"Em",   src:"audio/Em.mp3",   hint:"マイナー三和音（E–G–B）" },
      { key:"F",    label:"F",    src:"audio/F.mp3",    hint:"メジャー三和音（F–A–C）" },
      { key:"G",    label:"G",    src:"audio/G.mp3",    hint:"メジャー三和音（G–B–D）" },
      { key:"Am",   label:"Am",   src:"audio/Am.mp3",   hint:"マイナー三和音（A–C–E）" },
      { key:"Bm-5", label:"Bm-5", src:"audio/Bm-5.mp3", hint:"減三和音（B–D–F）" },

      { key:"CM7",   label:"CM7",   src:"audio/CM7.mp3",   hint:"M7（B）半音で寄る感じ" },
      { key:"Dm7",   label:"Dm7",   src:"audio/Dm7.mp3",   hint:"m7（C）" },
      { key:"Em7",   label:"Em7",   src:"audio/Em7.mp3",   hint:"m7（D）" },
      { key:"FM7",   label:"FM7",   src:"audio/FM7.mp3",   hint:"M7（E）" },
      { key:"G7",    label:"G7",    src:"audio/G7.mp3",    hint:"7（F）ドミナントの圧" },
      { key:"Am7",   label:"Am7",   src:"audio/Am7.mp3",   hint:"m7（G）" },
      { key:"Bm7-5", label:"Bm7-5", src:"audio/Bm7-5.mp3", hint:"m7♭5（A）" },

      { key:"E7",  label:"E7",  src:"audio/E7.mp3",  hint:"G#（長3度）外音が立つ" },
      { key:"A7",  label:"A7",  src:"audio/A7.mp3",  hint:"C#（長3度）外音で圧" },
      { key:"D7",  label:"D7",  src:"audio/D7.mp3",  hint:"F#（長3度）外音で圧" },
      { key:"C7",  label:"C7",  src:"audio/C7.mp3",  hint:"Bb（♭7）ブルース/ドミナント化" },
      { key:"D♭7", label:"D♭7", src:"audio/D♭7.mp3", hint:"代理ドミナントっぽい圧" },

      { key:"Fm",     label:"Fm",     src:"audio/Fm.mp3",     hint:"Ab（♭3）サブドミマイナー" },
      { key:"A♭",     label:"A♭",     src:"audio/A♭.mp3",     hint:"Abメジャー（借用の色）" },
      { key:"B♭",     label:"B♭",     src:"audio/B♭.mp3",     hint:"♭VIIのロック感" },
      { key:"E♭",     label:"E♭",     src:"audio/E♭.mp3",     hint:"♭IIIの色" },
      { key:"Gm",     label:"Gm",     src:"audio/Gm.mp3",     hint:"借用マイナーの匂い" },
      { key:"F#dim",  label:"F#dim",  src:"audio/F#dim.mp3",  hint:"減（緊張/経過）" },
      { key:"G#dim7", label:"G#dim7", src:"audio/G#dim7.mp3", hint:"短3度積み（意地悪枠）" },
    ];

    const POOLS = {
      d1: ["C","Dm","Em","F","G","Am","Bm-5"],
      d2: ["C","Dm","Em","F","G","Am","Bm-5","CM7","Dm7","Em7","FM7","G7","Am7","Bm7-5"],
      d3: ["C","Dm","Em","F","G","Am","Bm-5","E7","A7","D7","C7","D♭7"],
      d4: ["C","Dm","Em","F","G","Am","Bm-5","CM7","Dm7","Em7","FM7","G7","Am7","Bm7-5","E7","A7","D7","C7","D♭7"],
      d5: ALL.map(x => x.key),
    };

    // ===== DOM =====
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hintArea = document.getElementById("hintArea");

    const scoreEl  = document.getElementById("score");
    const totalEl  = document.getElementById("total");
    const accuracyEl = document.getElementById("accuracy");

    const btnStart = document.getElementById("btnStart");
    const btnReplay= document.getElementById("btnReplay");
    const btnReveal= document.getElementById("btnReveal");
    const btnHint  = document.getElementById("btnHint");
    const btnC     = document.getElementById("btnC");

    const difficultySel = document.getElementById("difficulty");
    const choicesWrap = document.getElementById("choices");

    // ===== state =====
    let current = null;
    let phase = "idle"; 
    // idle | answering | retryPrompt
    // idle: 未出題
    // answering: 出題して回答待ち
    // retryPrompt: 不正解後「再挑戦しますか？」状態

    let wrongAttemptsThisQuestion = 0;

    let score = 0;
    let total = 0;

    function getPoolKeys() {
      const diff = difficultySel.value;
      return POOLS[diff] ?? POOLS.d1;
    }
    function getItemByKey(key) {
      return ALL.find(m => m.key === key);
    }
    function pickRandomFromPool() {
      const poolKeys = getPoolKeys();
      const idx = Math.floor(Math.random() * poolKeys.length);
      return getItemByKey(poolKeys[idx]);
    }

    function clearHint() {
      hintArea.style.display = "none";
      hintArea.textContent = "";
    }

    function setReplayBlock(enabled){
      btnReplay.disabled = !enabled;
      btnReveal.disabled = !enabled;
      btnHint.disabled   = !enabled;
      btnC.disabled      = !enabled;
    }

    function setChoicesEnabled(enabled) {
      const btns = Array.from(document.querySelectorAll(".choice"));
      btns.forEach(b => b.disabled = !enabled);
    }

    function rebuildChoices() {
      choicesWrap.innerHTML = "";
      const pool = new Set(getPoolKeys());
      const items = ALL.filter(x => pool.has(x.key));

      items.forEach(item => {
        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = item.label;
        b.dataset.key = item.key;
        b.disabled = true;

        b.addEventListener("click", () => {
          if (phase !== "answering" || !current) return;

          const guess = b.dataset.key;
          const correct = (guess === current.key);

          if (correct) {
            // 正解確定：この時点で母数を増やす（出題瞬間に下がらない）
            total += 1;
            score += 1;
            scoreEl.textContent = String(score);
            totalEl.textContent = String(total);
            updateAccuracy();

            statusEl.classList.remove("warn");
            statusEl.textContent = `⭕ 正解！ ${current.label}（次の出題OK）`;

            phase = "idle";
            btnStart.disabled = false;
            setChoicesEnabled(false);
            setReplayBlock(false);
          } else {
            // 不正解：まだ母数に加えない／すぐ答えも出さない
            wrongAttemptsThisQuestion += 1;

            phase = "retryPrompt";
            statusEl.classList.add("warn");
            statusEl.textContent = "❌ 不正解… 再挑戦しますか？（もう一回 / 答え / 出題＝スキップ）";

            // 選択肢は一旦止める（再挑戦は「もう一回」から）
            setChoicesEnabled(false);

            // もう一回/答え/出題は押せるようにする
            setReplayBlock(true);

            // 出題＝スキップも許可（ただし処理はbtnStartで判定）
            btnStart.disabled = false;
          }
        });

        choicesWrap.appendChild(b);
      });
    }

    async function playSrc(src) {
      player.pause();
      player.currentTime = 0;
      player.src = encodeURI(src);
      await player.play();
    }

    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round((score / total) * 100);
      const accText = String(acc).padStart(2, "0") + "%";
      accuracyEl.textContent = `正答率 ${accText}`;
      if (acc >= 80) accuracyEl.classList.add("good");
      else accuracyEl.classList.remove("good");
    }

    // ===== events =====
    difficultySel.addEventListener("change", () => {
      clearHint();
      statusEl.classList.remove("warn");
      statusEl.textContent = "難易度を変更しました。出題してください。";

      current = null;
      phase = "idle";
      wrongAttemptsThisQuestion = 0;

      setReplayBlock(false);
      setChoicesEnabled(false);
      btnStart.disabled = false;

      rebuildChoices();
    });

    // 出題ボタン：
    // - idle：新規出題
    // - retryPrompt：スキップ扱い（＝不正解確定として母数に加える）→ 次の問題へ
    btnStart.addEventListener("click", async () => {
      // まず「再挑戦しますか？」中に押されたら＝スキップ
      if (phase === "retryPrompt" && current) {
        // 不正解確定として母数に加える（試行があったので）
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        statusEl.classList.remove("warn");
        statusEl.textContent = `スキップ：正解は ${current.label}（次の出題OK）`;

        // 次へ
        phase = "idle";
        current = null;
        wrongAttemptsThisQuestion = 0;
        setReplayBlock(false);
        setChoicesEnabled(false);
        // すぐ次を出せる
        // （ここで return しない：押し直しで次の出題ができるように）
        return;
      }

      // idle の時だけ新規出題
      if (phase !== "idle") return;

      current = pickRandomFromPool();
      wrongAttemptsThisQuestion = 0;
      phase = "answering";

      clearHint();
      statusEl.classList.remove("warn");
      statusEl.textContent = "出題中：聴いて選んでください。";

      // 出題中は出題ボタン無効（連打防止）
      btnStart.disabled = true;

      setReplayBlock(true);
      setChoicesEnabled(true);

      try {
        await playSrc(current.src);
      } catch (e) {
        statusEl.classList.add("warn");
        statusEl.textContent = "再生できませんでした。もう一度「出題」を押してください。";
        phase = "idle";
        btnStart.disabled = false;
      }
    });

    // もう一回：
    // - answering：再生だけ
    // - retryPrompt：再挑戦開始（不正解カウントを母数に反映）
    btnReplay.addEventListener("click", async () => {
      if (!current) return;

      clearHint();

      if (phase === "retryPrompt") {
        // 「もう一回」を押した＝その不正解は確定で母数に入れる
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        statusEl.classList.remove("warn");
        statusEl.textContent = "再挑戦：もう一回聴いて、答えを選んでください。";
        phase = "answering";

        // 再挑戦中は出題ボタンを無効（スキップ防止）
        btnStart.disabled = true;
        setChoicesEnabled(true);
      } else {
        statusEl.textContent = "もう一回再生しました。";
      }

      try { await playSrc(current.src); } catch {}
    });

    // 答え：
    // - retryPrompt：不正解確定（母数に入れる）→ 正解表示 → 次へ
    // - answering：ただ表示（採点にはしない）
    btnReveal.addEventListener("click", () => {
      if (!current) return;

      if (phase === "retryPrompt") {
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        statusEl.classList.remove("warn");
        statusEl.textContent = `答え：${current.label}（次の出題OK）`;

        phase = "idle";
        current = null;
        wrongAttemptsThisQuestion = 0;

        setReplayBlock(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
      } else {
        statusEl.textContent = `答え：${current.label}`;
      }
    });

    btnHint.addEventListener("click", () => {
      if (!current) return;
      hintArea.style.display = "block";
      hintArea.innerHTML = `<b>ヒント</b><br><code>${current.hint}</code>`;
    });

    btnC.addEventListener("click", async () => {
      try {
        await playSrc("audio/C.mp3");
        statusEl.textContent = "基準音：C を再生しました。";
      } catch (e) {
        statusEl.classList.add("warn");
        statusEl.textContent = "Cの再生に失敗しました。";
      }
    });

    // init
    rebuildChoices();
    setReplayBlock(false);
    setChoicesEnabled(false);
    btnStart.disabled = false;

    scoreEl.textContent = "0";
    totalEl.textContent = "0";
    updateAccuracy();
  </script>
</body>
</html>
