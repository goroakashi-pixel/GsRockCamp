<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diatonic</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --blue:#1d4ed8;
      --warn:#b91c1c;
      --pill:#f6f7fb;
    }
    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:140px;
      line-height:1.35;
    }
    .wrap{ max-width:860px; margin:0 auto; }

    h1{
      font-size:22px;
      margin: 6px 0 12px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .ver{ font-size:12px; color:var(--muted); font-weight:900; }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    .rowStack{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .setRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--pill);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
      flex:1 1 auto;
    }

    .title{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .lbl{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }

    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .seg label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space:nowrap;
    }
    .seg input{
      transform:scale(1.1);
      accent-color: var(--blue);
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    button{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{ opacity:.45; }

    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{ margin-top:12px; font-weight:900; }
    .status.warn{ color: var(--warn); }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
    }

    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{ color: var(--blue); }

    .choicesGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .choice{
      padding:14px 12px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      white-space:nowrap;
    }

    .backwrap{ margin-top:12px; }
    a.backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:900;
    }
    a.backbtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Diatonic <span class="ver">ver1.2</span></h1>

    <div class="box">
      <div class="rowStack">

        <!-- ① BASIC -->
        <div class="setRow" data-set="basic">
          <div class="left">
            <div class="title">① 基本ダイアトニック</div>
          </div>

          <div class="right">
            <span class="lbl">出題</span>
            <div class="seg">
              <label><input type="radio" name="en_basic" value="off">off</label>
              <label><input type="radio" name="en_basic" value="on" checked>on</label>
            </div>

            <span class="lbl">転回形</span>
            <div class="seg">
              <label><input type="radio" name="inv_basic" value="off" checked>off</label>
              <label><input type="radio" name="inv_basic" value="on">on</label>
            </div>
          </div>
        </div>

        <!-- ② PLUS -->
        <div class="setRow" data-set="plus">
          <div class="left">
            <div class="title">② PLUS（セカンダリーなど）</div>
          </div>

          <div class="right">
            <span class="lbl">出題</span>
            <div class="seg">
              <label><input type="radio" name="en_plus" value="off" checked>off</label>
              <label><input type="radio" name="en_plus" value="on">on</label>
            </div>

            <span class="lbl">転回形</span>
            <div class="seg">
              <label><input type="radio" name="inv_plus" value="off" checked>off</label>
              <label><input type="radio" name="inv_plus" value="on">on</label>
            </div>
          </div>
        </div>

        <!-- ③ HARD -->
        <div class="setRow" data-set="hard">
          <div class="left">
            <div class="title">③ HARD（高度な代用など）</div>
          </div>

          <div class="right">
            <span class="lbl">出題</span>
            <div class="seg">
              <label><input type="radio" name="en_hard" value="off" checked>off</label>
              <label><input type="radio" name="en_hard" value="on">on</label>
            </div>

            <span class="lbl">転回形</span>
            <div class="seg">
              <label><input type="radio" name="inv_hard" value="off" checked>off</label>
              <label><input type="radio" name="inv_hard" value="on">on</label>
            </div>
          </div>
        </div>

      </div>

      <div class="btn-row">
        <button id="btnStart">出題</button>
        <button id="btnReplay" disabled>もう一回</button>
        <button id="btnReveal" disabled>答え</button>
        <button id="btnHint" disabled>ヒント</button>
        <button id="btnC" disabled>C（基準音）</button>
      </div>

      <div id="status" class="status">待機中</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;">答え</div>
      <div class="choicesGrid" id="choices"></div>
    </div>

    <div class="box">
      <div class="scorebar">
        <div>スコア： <span id="score">0</span>/<span id="total">0</span></div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <div class="backwrap">
      <a class="backbtn" href="../../index.html">← 戻る</a>
    </div>

    <audio id="player" preload="auto"></audio>
  </div>

  <script>
  (() => {
    // 音源: GsRockCamp/games/diatonic/audio
    const AUDIO_BASE = "audio/";
    const AUDIO_VER  = "1.2.0"; // 音源差し替え時にここだけ変える

    // ===== データ（ファイル名はAb/Bb/Eb/Db7）=====
    const ITEMS = [
      // BASIC triads (inv対応)
      { id:"C",    label:"C",    files_root:["C.mp3"],    files_inv:["C.mp3","C_inv1.mp3","C_inv2.mp3"],    hint:"" },
      { id:"Dm",   label:"Dm",   files_root:["Dm.mp3"],   files_inv:["Dm.mp3","Dm_inv1.mp3","Dm_inv2.mp3"], hint:"" },
      { id:"Em",   label:"Em",   files_root:["Em.mp3"],   files_inv:["Em.mp3","Em_inv1.mp3","Em_inv2.mp3"], hint:"" },
      { id:"F",    label:"F",    files_root:["F.mp3"],    files_inv:["F.mp3","F_inv1.mp3","F_inv2.mp3"],    hint:"" },
      { id:"G",    label:"G",    files_root:["G.mp3"],    files_inv:["G.mp3","G_inv1.mp3","G_inv2.mp3"],    hint:"" },
      { id:"Am",   label:"Am",   files_root:["Am.mp3"],   files_inv:["Am.mp3","Am_inv1.mp3","Am_inv2.mp3"], hint:"" },
      { id:"Bm-5", label:"Bm-5", files_root:["Bm-5.mp3"], files_inv:["Bm-5.mp3","Bm-5_inv1.mp3","Bm-5_inv2.mp3"], hint:"" },

      // PLUS / HARD（現時点ではinv未整備でも安全）
      { id:"C7",   label:"C7",   files_root:["C7.mp3"],   files_inv:[], hint:"" },
      { id:"CM7",  label:"CM7",  files_root:["CM7.mp3"],  files_inv:[], hint:"" },
      { id:"Dm7",  label:"Dm7",  files_root:["Dm7.mp3"],  files_inv:[], hint:"" },
      { id:"Em7",  label:"Em7",  files_root:["Em7.mp3"],  files_inv:[], hint:"" },
      { id:"FM7",  label:"FM7",  files_root:["FM7.mp3"],  files_inv:[], hint:"" },
      { id:"G7",   label:"G7",   files_root:["G7.mp3"],   files_inv:[], hint:"" },
      { id:"Am7",  label:"Am7",  files_root:["Am7.mp3"],  files_inv:[], hint:"" },
      { id:"Bm7-5",label:"Bm7-5",files_root:["Bm7-5.mp3"],files_inv:[], hint:"" },

      { id:"E7",   label:"E7",   files_root:["E7.mp3"],   files_inv:[], hint:"" },
      { id:"A7",   label:"A7",   files_root:["A7.mp3"],   files_inv:[], hint:"" },
      { id:"D7",   label:"D7",   files_root:["D7.mp3"],   files_inv:[], hint:"" },
      { id:"Db7",  label:"D♭7",  files_root:["Db7.mp3"],  files_inv:[], hint:"" },

      { id:"Fm",     label:"Fm",     files_root:["Fm.mp3"],     files_inv:[], hint:"" },
      { id:"Ab",     label:"A♭",     files_root:["Ab.mp3"],     files_inv:[], hint:"" },
      { id:"Bb",     label:"B♭",     files_root:["Bb.mp3"],     files_inv:[], hint:"" },
      { id:"Eb",     label:"E♭",     files_root:["Eb.mp3"],     files_inv:[], hint:"" },
      { id:"Gm",     label:"Gm",     files_root:["Gm.mp3"],     files_inv:[], hint:"" },
      { id:"F#dim",  label:"F#dim",  files_root:["F#dim.mp3"],  files_inv:[], hint:"" },
      { id:"G#dim7", label:"G#dim7", files_root:["G#dim7.mp3"], files_inv:[], hint:"" },
    ];
    const byId = new Map(ITEMS.map(x => [x.id, x]));

    const POOLS = {
      basic: ["C","Dm","Em","F","G","Am","Bm-5"],
      plus:  ["E7","A7","D7","C7","Db7"],
      hard:  ["Fm","Ab","Bb","Eb","Gm","F#dim","G#dim7"],
    };

    // ===== DOM =====
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hintArea = document.getElementById("hintArea");

    const scoreEl  = document.getElementById("score");
    const totalEl  = document.getElementById("total");
    const accuracyEl = document.getElementById("accuracy");

    const btnStart = document.getElementById("btnStart");
    const btnReplay= document.getElementById("btnReplay");
    const btnReveal= document.getElementById("btnReveal");
    const btnHint  = document.getElementById("btnHint");
    const btnC     = document.getElementById("btnC");

    const choicesWrap = document.getElementById("choices");

    // ===== state =====
    let phase = "idle";      // idle | answering | retryPrompt
    let current = null;      // { id, label, file, hint }
    let score = 0;
    let total = 0;

    // ===== helpers =====
    function setStatus(text, warn=false){
      statusEl.textContent = text;
      statusEl.classList.toggle("warn", !!warn);
    }

    function clearHint(){
      hintArea.style.display = "none";
      hintArea.textContent = "";
    }

    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round((score / total) * 100);
      const accText = String(acc).padStart(2, "0") + "%";
      accuracyEl.textContent = `正答率 ${accText}`;
      accuracyEl.classList.toggle("good", acc >= 80);
    }

    function setReplayBlock(enabled){
      btnReplay.disabled = !enabled;
      btnReveal.disabled = !enabled;
      btnHint.disabled   = !enabled;
      btnC.disabled      = !enabled;
    }

    function setChoicesEnabled(enabled){
      Array.from(document.querySelectorAll(".choice")).forEach(b => b.disabled = !enabled);
    }

    function buildSrc(file){
      const url = encodeURI(AUDIO_BASE + file);
      return url + "?v=" + encodeURIComponent(AUDIO_VER);
    }

    async function playFile(file){
      player.pause();
      player.currentTime = 0;
      player.src = buildSrc(file);
      await player.play();
    }

    function getEn(setKey){
      const el = document.querySelector(`input[name="en_${setKey}"]:checked`);
      return el ? el.value : "off";
    }

    function getInv(setKey){
      const el = document.querySelector(`input[name="inv_${setKey}"]:checked`);
      return el ? el.value : "off";
    }

    function getEnabledSets(){
      const sets = [];
      if (getEn("basic") === "on") sets.push("basic");
      if (getEn("plus")  === "on") sets.push("plus");
      if (getEn("hard")  === "on") sets.push("hard");
      return sets;
    }

    function unionPoolIds(){
      const enabled = getEnabledSets();
      const ids = [];
      const seen = new Set();
      enabled.forEach(k => {
        (POOLS[k] || []).forEach(id => {
          if (!seen.has(id)) { seen.add(id); ids.push(id); }
        });
      });
      return ids;
    }

    function safeFiles(item, wantInv){
      const root = Array.isArray(item.files_root) && item.files_root.length ? item.files_root : [];
      const inv  = Array.isArray(item.files_inv)  && item.files_inv.length  ? item.files_inv  : [];
      if (wantInv && inv.length) return inv;
      return root.length ? root : inv;
    }

    function pickQuestion(){
      const enabled = getEnabledSets();
      if (enabled.length === 0) return null;

      // どのセットから出すか（有効セットからランダム）
      const setKey = enabled[Math.floor(Math.random() * enabled.length)];
      const pool = POOLS[setKey] || [];
      if (!pool.length) return null;

      const id = pool[Math.floor(Math.random() * pool.length)];
      const item = byId.get(id);
      if (!item) return null;

      // 転回形：basicのみ有効。plus/hardは常にoff扱い。
      const invWanted = (setKey === "basic") && (getInv("basic") === "on");
      const files = safeFiles(item, invWanted);
      if (!files || !files.length) return null;

      const file = files[Math.floor(Math.random() * files.length)];
      return { id: item.id, label: item.label, hint: item.hint || "", file, setKey };
    }

    function rebuildChoices(){
      const ids = unionPoolIds();
      choicesWrap.innerHTML = "";

      ids.forEach(id => {
        const item = byId.get(id);
        if (!item) return;

        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = item.label;
        b.dataset.id = item.id;
        b.disabled = true;

        b.addEventListener("click", () => {
          if (phase !== "answering" || !current) return;

          const guess = b.dataset.id;
          if (guess === current.id){
            total += 1;
            score += 1;
            totalEl.textContent = String(total);
            scoreEl.textContent = String(score);
            updateAccuracy();

            setStatus(`⭕ 正解！ ${current.label}`);
            phase = "idle";
            current = null;

            setChoicesEnabled(false);
            setReplayBlock(false);
            btnStart.disabled = false;
          } else {
            phase = "retryPrompt";
            setStatus("❌ 不正解…（もう一回 / 答え / 出題＝スキップ）", true);

            setChoicesEnabled(false);
            setReplayBlock(true);
            btnStart.disabled = false; // スキップを許可
          }
        });

        choicesWrap.appendChild(b);
      });

      // 有効セットがなくて選択肢ゼロのときはボタンも無効に寄せる
      if (ids.length === 0){
        setChoicesEnabled(false);
      }
    }

    function resetToIdle(msg){
      phase = "idle";
      current = null;
      clearHint();
      setReplayBlock(false);
      setChoicesEnabled(false);
      btnStart.disabled = false;
      setStatus(msg || "待機中");
    }

    // ===== UI挙動：plus/hardの転回形onは押せるが即offへ戻す =====
    function attachInvTrap(setKey){
      const onEl  = document.querySelector(`input[name="inv_${setKey}"][value="on"]`);
      const offEl = document.querySelector(`input[name="inv_${setKey}"][value="off"]`);

      if (!onEl || !offEl) return;

      onEl.addEventListener("change", () => {
        if (onEl.checked){
          // 即オフに戻す
          offEl.checked = true;
          setStatus(`③②の転回形は未実装です。`, true);
          resetForSettingChange();
        }
      });
    }

    function resetForSettingChange(){
      // 出題中に変更されたら待機へ戻す
      if (phase !== "idle"){
        resetToIdle("設定を変更しました。出題してください。");
      } else {
        setStatus("設定を変更しました。");
      }
      rebuildChoices();
    }

    // ===== 変更イベント（出題セット on/off、basicの転回形、plus/hardの転回形も含めて）=====
    ["basic","plus","hard"].forEach(setKey => {
      document.querySelectorAll(`input[name="en_${setKey}"]`).forEach(el => {
        el.addEventListener("change", resetForSettingChange);
      });
      document.querySelectorAll(`input[name="inv_${setKey}"]`).forEach(el => {
        el.addEventListener("change", resetForSettingChange);
      });
    });

    // plus/hardの転回形onトラップ
    attachInvTrap("plus");
    attachInvTrap("hard");

    // ===== buttons =====
    btnStart.addEventListener("click", async () => {
      // retryPrompt中に押されたら＝スキップ確定（total++）
      if (phase === "retryPrompt" && current){
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`スキップ：正解は ${current.label}`);
        phase = "idle";
        current = null;

        setReplayBlock(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
        return;
      }

      if (phase !== "idle") return;

      const ids = unionPoolIds();
      if (ids.length === 0){
        setStatus("出題がすべてoffです。", true);
        return;
      }

      current = pickQuestion();
      if (!current){
        setStatus("出題データが見つかりません（音源名を確認してください）。", true);
        current = null;
        return;
      }

      clearHint();
      setStatus("出題中");
      phase = "answering";

      btnStart.disabled = true;
      setReplayBlock(true);
      setChoicesEnabled(true);

      try{
        await playFile(current.file);
      }catch(e){
        setStatus("再生できません。音源パス/ファイル名を確認してください。", true);
        resetToIdle("待機中");
      }
    });

    btnReplay.addEventListener("click", async () => {
      if (!current) return;
      clearHint();

      if (phase === "retryPrompt"){
        // 不正解確定として total++
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus("再挑戦");
        phase = "answering";
        btnStart.disabled = true;
        setChoicesEnabled(true);
      } else {
        setStatus("もう一回");
      }

      try{ await playFile(current.file); }catch(e){}
    });

    btnReveal.addEventListener("click", () => {
      if (!current) return;

      if (phase === "retryPrompt"){
        total += 1;
        totalEl.textContent = String(total);
        updateAccuracy();

        setStatus(`答え：${current.label}`);
        phase = "idle";
        current = null;

        setReplayBlock(false);
        setChoicesEnabled(false);
        btnStart.disabled = false;
      } else {
        setStatus(`答え：${current.label}`);
      }
    });

    btnHint.addEventListener("click", () => {
      if (!current) return;
      hintArea.style.display = "block";
      hintArea.textContent = current.hint ? current.hint : "（なし）";
    });

    btnC.addEventListener("click", async () => {
      try{
        await playFile("C.mp3");
        setStatus("C（基準音）");
      }catch(e){
        setStatus("Cを再生できません。", true);
      }
    });

    // init
    scoreEl.textContent = "0";
    totalEl.textContent = "0";
    updateAccuracy();
    rebuildChoices();
    resetToIdle("待機中");
  })();
  </script>
</body>
</html>
