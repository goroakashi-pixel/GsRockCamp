<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diatonic Chord Quiz</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --blue:#1d4ed8;
    }

    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:120px;
    }

    .wrap{
      max-width:820px;
      margin:0 auto;
    }

    h1{
      font-size:22px;
      margin: 6px 0 12px;
      letter-spacing:.2px;
    }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    label{
      font-weight:800;
      display:inline-block;
      margin-right:8px;
    }

    select{
      width:100%;
      padding:12px 12px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }

    .row{ margin-top:10px; }

    /* buttons */
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    button{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{ opacity:.45; }

    /* Big start button */
    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{
      margin-top:12px;
      font-weight:900;
    }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
    }

    /* score */
    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .scoreleft{ font-size:16px; }
    .accuracy{ font-size:16px; }
    .accuracy.good{ color: var(--blue); }

    /* choices */
    .grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .choice{
      white-space:nowrap;
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
    }

    /* back (bottom) */
    .grc-backwrap{ margin-top: 12px; }
    a.grc-backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    a.grc-backbtn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Diatonic Chord Quiz</h1>

    <div class="box">
      <div class="row">
        <label for="difficulty">難易度選択</label>
        <select id="difficulty">
          <option value="d1">① 3和音ダイアトニックのみ</option>
          <option value="d2">② 4和音ダイアトニックを①に加える</option>
          <option value="d3">③ ノーマル群を①に加える</option>
          <option value="d4">④ ノーマル群を②に加える</option>
          <option value="d5">⑤ 全部（意地悪枠込み）</option>
        </select>
      </div>

      <div class="btn-row">
        <button id="btnStart">出題</button>
        <button id="btnReplay" disabled>もう一回</button>
        <button id="btnReveal" disabled>答え</button>
        <button id="btnHint" disabled>ヒント</button>
        <button id="btnC" disabled>C（基準音）</button>
      </div>

      <div id="status" class="status">まだ出題していません</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;">答えを選んでください</div>
      <div class="grid" id="choices"></div>
    </div>

    <div class="box">
      <div class="scorebar">
        <div class="scoreleft">
          スコア：
          <span id="score">0</span>/<span id="total">0</span>
        </div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <!-- back to portal (bottom) -->
    <div class="grc-backwrap">
      <a class="grc-backbtn" href="../../index.html">← ポータルに戻る</a>
    </div>

    <audio id="player" preload="auto"></audio>
  </div>

  <script>
    // ===== 出題データ（※既存のファイル名をそのまま使用）=====
    const ALL = [
      // --- ① 3和音ダイアトニック ---
      { key:"C",    label:"C",    src:"audio/C.mp3",    hint:"Cメジャー三和音（C–E–G）" },
      { key:"Dm",   label:"Dm",   src:"audio/Dm.mp3",   hint:"マイナー三和音（D–F–A）" },
      { key:"Em",   label:"Em",   src:"audio/Em.mp3",   hint:"マイナー三和音（E–G–B）" },
      { key:"F",    label:"F",    src:"audio/F.mp3",    hint:"メジャー三和音（F–A–C）" },
      { key:"G",    label:"G",    src:"audio/G.mp3",    hint:"メジャー三和音（G–B–D）" },
      { key:"Am",   label:"Am",   src:"audio/Am.mp3",   hint:"マイナー三和音（A–C–E）" },
      { key:"Bm-5", label:"Bm-5", src:"audio/Bm-5.mp3", hint:"減三和音（B–D–F）" },

      // --- ② 4和音ダイアトニック ---
      { key:"CM7",   label:"CM7",   src:"audio/CM7.mp3",   hint:"M7（B）半音で寄る感じ" },
      { key:"Dm7",   label:"Dm7",   src:"audio/Dm7.mp3",   hint:"m7（C）" },
      { key:"Em7",   label:"Em7",   src:"audio/Em7.mp3",   hint:"m7（D）" },
      { key:"FM7",   label:"FM7",   src:"audio/FM7.mp3",   hint:"M7（E）" },
      { key:"G7",    label:"G7",    src:"audio/G7.mp3",    hint:"7（F）ドミナントの圧" },
      { key:"Am7",   label:"Am7",   src:"audio/Am7.mp3",   hint:"m7（G）" },
      { key:"Bm7-5", label:"Bm7-5", src:"audio/Bm7-5.mp3", hint:"m7♭5（A）" },

      // --- ③④ ノーマル群 ---
      { key:"E7",  label:"E7",  src:"audio/E7.mp3",  hint:"G#（長3度）外音が立つ" },
      { key:"A7",  label:"A7",  src:"audio/A7.mp3",  hint:"C#（長3度）外音で圧" },
      { key:"D7",  label:"D7",  src:"audio/D7.mp3",  hint:"F#（長3度）外音で圧" },
      { key:"C7",  label:"C7",  src:"audio/C7.mp3",  hint:"Bb（♭7）ブルース/ドミナント化" },
      { key:"D♭7", label:"D♭7", src:"audio/D♭7.mp3", hint:"代理ドミナントっぽい圧" },

      // --- ⑤ 意地悪枠 ---
      { key:"Fm",     label:"Fm",     src:"audio/Fm.mp3",     hint:"Ab（♭3）サブドミマイナー" },
      { key:"A♭",     label:"A♭",     src:"audio/A♭.mp3",     hint:"Abメジャー（借用の色）" },
      { key:"B♭",     label:"B♭",     src:"audio/B♭.mp3",     hint:"♭VIIのロック感" },
      { key:"E♭",     label:"E♭",     src:"audio/E♭.mp3",     hint:"♭IIIの色" },
      { key:"Gm",     label:"Gm",     src:"audio/Gm.mp3",     hint:"借用マイナーの匂い" },
      { key:"F#dim",  label:"F#dim",  src:"audio/F#dim.mp3",  hint:"減（緊張/経過）" },
      { key:"G#dim7", label:"G#dim7", src:"audio/G#dim7.mp3", hint:"短3度積み（意地悪枠）" },
    ];

    const POOLS = {
      d1: ["C","Dm","Em","F","G","Am","Bm-5"],
      d2: [
        "C","Dm","Em","F","G","Am","Bm-5",
        "CM7","Dm7","Em7","FM7","G7","Am7","Bm7-5"
      ],
      d3: [
        "C","Dm","Em","F","G","Am","Bm-5",
        "E7","A7","D7","C7","D♭7"
      ],
      d4: [
        "C","Dm","Em","F","G","Am","Bm-5",
        "CM7","Dm7","Em7","FM7","G7","Am7","Bm7-5",
        "E7","A7","D7","C7","D♭7"
      ],
      d5: ALL.map(x => x.key),
    };

    // ===== DOM =====
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hintArea = document.getElementById("hintArea");

    const scoreEl  = document.getElementById("score");
    const totalEl  = document.getElementById("total");
    const accuracyEl = document.getElementById("accuracy");

    const btnStart = document.getElementById("btnStart");
    const btnReplay= document.getElementById("btnReplay");
    const btnReveal= document.getElementById("btnReveal");
    const btnHint  = document.getElementById("btnHint");
    const btnC     = document.getElementById("btnC");

    const difficultySel = document.getElementById("difficulty");
    const choicesWrap = document.getElementById("choices");

    // ===== state =====
    let current = null;
    let inQuestion = false;   // 出題中（未回答）
    let score = 0;
    let total = 0;

    function getPoolKeys() {
      const diff = difficultySel.value;
      return POOLS[diff] ?? POOLS.d1;
    }

    function getItemByKey(key) {
      return ALL.find(m => m.key === key);
    }

    function pickRandomFromPool() {
      const poolKeys = getPoolKeys();
      const idx = Math.floor(Math.random() * poolKeys.length);
      return getItemByKey(poolKeys[idx]);
    }

    function clearHint() {
      hintArea.style.display = "none";
      hintArea.textContent = "";
    }

    function setReplayBlockEnabled(enabled){
      btnReplay.disabled = !enabled;
      btnReveal.disabled = !enabled;
      btnHint.disabled   = !enabled;
      btnC.disabled      = !enabled;
    }

    function setChoicesEnabled(enabled) {
      const btns = Array.from(document.querySelectorAll(".choice"));
      btns.forEach(b => b.disabled = !enabled);
    }

    function rebuildChoices() {
      choicesWrap.innerHTML = "";
      const pool = new Set(getPoolKeys());
      const items = ALL.filter(x => pool.has(x.key));

      items.forEach(item => {
        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = item.label;
        b.dataset.key = item.key;
        b.disabled = true;

        b.addEventListener("click", () => {
          if (!inQuestion || !current) return;

          // 回答確定
          inQuestion = false;
          setChoicesEnabled(false);

          const guess = b.dataset.key;
          const correct = (guess === current.key);

          if (correct) {
            score += 1;
            scoreEl.textContent = String(score);
            statusEl.textContent = `⭕ 正解！ ${current.label}（次の出題OK）`;
          } else {
            statusEl.textContent = `❌ 不正解… 正解は ${current.label}（もう一回聴けます）`;
          }

          // 回答後も「もう一回」などは使える
          setReplayBlockEnabled(true);

          // 次の問題を出せるようにする（連打で勝手にカウントされるのを防ぐ）
          btnStart.disabled = false;

          updateAccuracy();
        });

        choicesWrap.appendChild(b);
      });
    }

    async function playSrc(src) {
      player.pause();
      player.currentTime = 0;
      player.src = encodeURI(src);
      await player.play();
    }

    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round((score / total) * 100);
      const accText = String(acc).padStart(2, "0") + "%";
      accuracyEl.textContent = `正答率 ${accText}`;
      if (acc >= 80) accuracyEl.classList.add("good");
      else accuracyEl.classList.remove("good");
    }

    // ===== events =====
    difficultySel.addEventListener("change", () => {
      clearHint();
      statusEl.textContent = "難易度を変更しました。出題してください。";

      current = null;
      inQuestion = false;

      setReplayBlockEnabled(false);
      setChoicesEnabled(false);
      btnStart.disabled = false;

      rebuildChoices();
    });

    btnStart.addEventListener("click", async () => {
      // 出題中は押せない（連打でスコア/正答率が変になるのを防ぐ）
      if (inQuestion) return;

      current = pickRandomFromPool();
      inQuestion = true;

      // 出題を確定した時だけ total を増やす
      total += 1;
      totalEl.textContent = String(total);
      updateAccuracy();

      clearHint();
      statusEl.textContent = "出題中：聴いて選んでください。";

      // 出題中は出題ボタンを無効化
      btnStart.disabled = true;

      // 出題中は選択＆再生系ボタンは使える
      setReplayBlockEnabled(true);
      setChoicesEnabled(true);

      try {
        await playSrc(current.src);
      } catch (e) {
        statusEl.textContent = "再生できませんでした。もう一度「出題」を押してください。";
        inQuestion = false;
        btnStart.disabled = false;
      }
    });

    btnReplay.addEventListener("click", async () => {
      if (!current) return;
      clearHint();
      statusEl.textContent = "もう一回再生しました。";
      try { await playSrc(current.src); } catch {}
    });

    btnReveal.addEventListener("click", () => {
      if (!current) return;
      statusEl.textContent = `答え：${current.label}`;
    });

    btnHint.addEventListener("click", () => {
      if (!current) return;
      hintArea.style.display = "block";
      hintArea.innerHTML = `<b>ヒント</b><br><code>${current.hint}</code>`;
    });

    btnC.addEventListener("click", async () => {
      try {
        await playSrc("audio/C.mp3");
        statusEl.textContent = "基準音：C を再生しました。";
      } catch (e) {
        statusEl.textContent = "Cの再生に失敗しました。";
      }
    });

    // init
    rebuildChoices();
    setReplayBlockEnabled(false);
    setChoicesEnabled(false);
    btnStart.disabled = false;
    scoreEl.textContent = "0";
    totalEl.textContent = "0";
    updateAccuracy();
  </script>
</body>
</html>
