<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chord Qualities Quiz</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --card:#fff;
      --blue:#1d4ed8;
      --ok:#2b8a3e;
      --ng:#c92a2a;
    }

    body{
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      margin:18px;
      line-height:1.35;
      padding-bottom:120px;
    }

    h1{
      font-size:22px;
      margin-bottom:6px;
    }
    .ver{
      font-size:12px;
      color:var(--muted);
      margin-left:6px;
      font-weight:normal;
    }

    .muted{color:var(--muted)}

    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin:14px 0;
      background:var(--card);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0;
    }

    button,select{
      font-size:16px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:700;
    }

    #btnNext{
      font-size:20px;
      padding:16px 18px;
      flex:1 1 220px;
    }

    button:disabled{opacity:.45}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
      gap:10px;
      margin-top:10px;
    }

    .opt{
      padding:14px;
      border:1px solid #ccc;
      border-radius:14px;
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .opt:disabled{opacity:.45;cursor:not-allowed}
    .opt.ok{border-color:var(--ok)}
    .opt.ng{border-color:var(--ng)}

    .scorebar{
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{color:var(--blue)}

    .footer-back{
      margin-top:24px;
      text-align:center;
    }
    .footer-back a{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      font-weight:800;
    }
  </style>
</head>

<body>

<h1>Chord Qualities Quiz <span class="ver">ver1.0</span></h1>
<div class="muted">C基準で、コードの「品質（キャラ）」を当てます。</div>

<div class="card">
  <div class="row">
    <label>セット：
      <select id="setSel">
        <option value="basic">BASIC（6種）</option>
        <option value="plus">PLUS（10種）</option>
        <option value="hard">HARD（18種）</option>
      </select>
    </label>
  </div>

  <div class="row">
    <button id="btnNext">出題</button>
    <button id="btnReplay" disabled>もう一回</button>
    <button id="btnReveal" disabled>答え</button>
    <button id="btnHint" disabled>ヒント</button>
    <button id="btnC">C（基準）</button>
  </div>

  <div class="row scorebar">
    <div>スコア：<span id="score">0</span>/<span id="total">0</span></div>
    <div id="accuracy" class="accuracy">正答率 00%</div>
  </div>

  <div class="muted">状態：<span id="status">待機中</span></div>
</div>

<div class="card">
  <b>選択肢</b>
  <div class="grid" id="opts"></div>
</div>

<div class="card">
  <b>ヒント</b>
  <div id="hintText" class="muted">まだ出題していません。</div>
</div>

<div class="card">
  <b>答え</b>
  <div id="answerText" class="muted">未表示</div>
</div>

<div class="footer-back">
  <a href="../../index.html">← ポータルに戻る</a>
</div>

<script>
(() => {
  const VER = "1.0";

  const SETS = {
    basic: [
      {id:"C",label:"C",file:"C.mp3",hint:"長3度のまっすぐな明るさ"},
      {id:"Cm",label:"Cm",file:"Cm.mp3",hint:"短3度の影"},
      {id:"C7",label:"C7",file:"C7.mp3",hint:"行きたがるドミナント感"},
      {id:"CM7",label:"CM7",file:"Cmaj7.mp3",hint:"Maj7の都会感"},
      {id:"Csus4",label:"Csus4",file:"Csus4.mp3",hint:"3度を外した保留"},
      {id:"Caug",label:"Caug",file:"Caug.mp3",hint:"増5度の浮遊"},
    ],
    plus: [],
    hard: []
  };
  SETS.plus = [...SETS.basic,
    {id:"Cm7",label:"Cm7",file:"Cm7.mp3",hint:"マイナー＋♭7"},
    {id:"Cdim",label:"Cdim",file:"Cdim.mp3",hint:"減5度の不安"},
    {id:"C6",label:"C6",file:"C6.mp3",hint:"6thの温かさ"},
    {id:"Cadd9",label:"Cadd9",file:"Cadd9.mp3",hint:"開放的な9th"},
  ];
  SETS.hard = [...SETS.plus,
    {id:"Csus2",label:"Csus2",file:"Csus2.mp3",hint:"軽い保留"},
    {id:"C7sus2",label:"C7sus2",file:"C7sus2.mp3",hint:"行きたいが言い切らない"},
    {id:"Cdim7",label:"Cdim7",file:"Cdim7.mp3",hint:"回る不安"},
    {id:"Cm6",label:"Cm6",file:"Cm6.mp3",hint:"影に灯り"},
    {id:"C9",label:"C9",file:"C9.mp3",hint:"7より柔らかい濁り"},
    {id:"CM9",label:"CM9",file:"Cmaj9.mp3",hint:"広く透明"},
    {id:"Cm9",label:"Cm9",file:"Cm9.mp3",hint:"影の広がり"},
    {id:"CmM7",label:"CmM7",file:"CmM7.mp3",hint:"妖しい切なさ"},
  ];

  let pool = SETS.basic;
  let current = null;
  let locked = true;
  let pendingWrong = false;

  let score = 0;
  let total = 0;

  const audio = new Audio();

  const $ = id => document.getElementById(id);
  const opts = $("opts");
  const status = $("status");
  const hintText = $("hintText");
  const answerText = $("answerText");
  const scoreEl = $("score");
  const totalEl = $("total");
  const accuracyEl = $("accuracy");

  function updateAccuracy(){
    const acc = total===0 ? 0 : Math.round(score/total*100);
    accuracyEl.textContent = "正答率 " + String(acc).padStart(2,"0") + "%";
    accuracyEl.classList.toggle("good", acc>=80);
  }

  function buildOptions(){
    opts.innerHTML="";
    pool.forEach(q=>{
      const b=document.createElement("button");
      b.className="opt";
      b.textContent=q.label;
      b.disabled=true;
      b.onclick=()=>answer(q,b);
      opts.appendChild(b);
    });
  }

  function enableOptions(on){
    [...opts.children].forEach(b=>b.disabled=!on);
  }

  function play(file){
    audio.src="audio/"+file+"?v="+VER;
    audio.currentTime=0;
    audio.play();
  }

  function start(){
    current=pool[Math.floor(Math.random()*pool.length)];
    locked=false;
    pendingWrong=false;
    status.textContent="出題中";
    hintText.textContent="まだヒントは出していません。";
    answerText.textContent="未表示";
    enableOptions(true);
    play(current.file);
    $("btnReplay").disabled=false;
    $("btnHint").disabled=false;
    $("btnReveal").disabled=false;
  }

  function answer(choice,btn){
    if(locked) return;

    if(choice.id===current.id){
      total++; score++;
      scoreEl.textContent=score;
      totalEl.textContent=total;
      updateAccuracy();
      btn.classList.add("ok");
      status.textContent="正解！";
      locked=true;
      enableOptions(false);
    }else{
      btn.classList.add("ng");
      pendingWrong=true;
      status.textContent="不正解… 再挑戦しますか？";
      locked=true;
      enableOptions(false);
    }
  }

  $("btnNext").onclick=()=>{
    if(pendingWrong){
      total++;
      totalEl.textContent=total;
      updateAccuracy();
      pendingWrong=false;
    }
    start();
  };

  $("btnReplay").onclick=()=>{
    if(!current) return;
    play(current.file);
    if(pendingWrong){
      locked=false;
      enableOptions(true);
      status.textContent="再挑戦どうぞ";
    }
  };

  $("btnReveal").onclick=()=>{
    if(!current) return;
    if(pendingWrong){
      total++;
      totalEl.textContent=total;
      updateAccuracy();
      pendingWrong=false;
    }
    answerText.textContent="答え："+current.label;
    status.textContent="答えを表示しました";
  };

  $("btnHint").onclick=()=>{ if(current) hintText.textContent=current.hint; };
  $("btnC").onclick=()=>play("C.mp3");

  $("setSel").onchange=e=>{
    pool=SETS[e.target.value];
    buildOptions();
    status.textContent="セット変更しました";
  };

  buildOptions();
})();
</script>
</body>
</html>
