<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chord Qualities Quiz</title>
  <!--
  ver1.3:
  - audio/2・3・4 対応
  - Oct- / Oct+ の追加式仕様
  - inversion混在抽選
  - Bluetooth対策の無音ウォームアップ追加
  - Cmaj7/Cmaj9へ内部ID統一
  -->

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#ddd;
      --bg:#fff;
      --card:#fff;
      --blue:#1d4ed8;
      --warn:#b91c1c;

      --btn-bg:#fff;
      --btn-on-border: 2px solid var(--blue);
      --btn-off-border: 1px solid var(--line);
      --btn-radius: 16px;

      --oct-font: 14px;
      --main-font: 16px;
      --title-font: 22px;

      --tap-min-h: 44px;
    }

    body{
      font-family:-apple-system, system-ui, "Segoe UI", sans-serif;
      margin:16px;
      color:var(--text);
      background:var(--bg);
      padding-bottom:140px;
    }

    .wrap{ max-width:820px; margin:0 auto; }

    h1{
      font-size:var(--title-font);
      margin:6px 0 6px;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .ver{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .muted{ color:var(--muted); }

    .changelog{
      margin:0 0 12px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
    }
    .changelog-title{
      font-weight:900;
      margin:0 0 6px;
      color:var(--muted);
      font-size:12px;
    }
    .changelog ul{
      margin:0;
      padding-left:18px;
      color:#333;
      line-height:1.4;
      font-size:13px;
    }
    .changelog li{ margin:4px 0; }

    .box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      margin-top:12px;
    }

    .block{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fafafa;
      margin-top:12px;
    }
    .block-title{
      font-weight:900;
      font-size:18px;
      margin:0 0 10px;
    }

    .opt-row{
      display:grid;
      grid-template-columns: minmax(160px, 1fr) minmax(160px, 1fr);
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }

    .btn{
      width:100%;
      min-height: var(--tap-min-h);
      padding:12px 14px;
      font-size:var(--main-font);
      border-radius:var(--btn-radius);
      border: var(--btn-off-border);
      background:var(--btn-bg);
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.45; }
    .btn.on{ border: var(--btn-on-border); }

    .btn small{
      font-weight:900;
      color:var(--muted);
      letter-spacing:.3px;
    }

    .oct-pair{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .oct-btn{
      width:100%;
      min-height: var(--tap-min-h);
      padding:10px 10px;
      font-size:var(--oct-font);
      border-radius:999px;
      border: var(--btn-off-border);
      background:var(--btn-bg);
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .oct-btn:active{ transform: translateY(1px); }
    .oct-btn[disabled]{ opacity:.45; }
    .oct-btn.on{ border: var(--btn-on-border); }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    button.ctrl{
      padding:12px 14px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    button.ctrl:disabled{ opacity:.45; }
    #btnStart{
      flex: 1 1 220px;
      font-size:20px;
      padding:16px 18px;
    }

    .status{ margin-top:12px; font-weight:900; }
    .status.warn{ color: var(--warn); }

    .hintArea{
      margin-top:10px;
      padding:12px;
      border:1px dashed #aaa;
      border-radius:12px;
      display:none;
      background:#fafafa;
      white-space:pre-wrap;
      line-height:1.5;
    }

    .scorebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .accuracy.good{ color: var(--blue); }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .choice{
      padding:14px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    .choice:disabled{ opacity:.45; }
    .choice.ok{ border-color:#2b8a3e; }
    .choice.ng{ border-color:#c92a2a; }

    .note{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }

    .backwrap{ margin-top: 12px; text-align:center; }
    a.backbtn{
      display:inline-block;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background:var(--card);
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    a.backbtn:active{ transform: translateY(1px); }

    @media (max-width: 420px){
      .opt-row{ grid-template-columns: 1fr; }
      .oct-pair{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      Chord Qualities Quiz
      <span class="ver" id="verText">ver1.3</span>
    </h1>
    <div class="muted">C基準で、コードの「品質（キャラ）」を当てます。</div>

    <div class="changelog">
      <div class="changelog-title">開発中の仕様確認（主な修正点）</div>
      <ul>
        <li>ver1.3：audio/2・3・4 対応、Oct- / Oct+ 追加式</li>
        <li>ver1.3：転回形の混在抽選（root + inv）</li>
        <li>ver1.3：Bluetooth対策の無音ウォームアップ</li>
        <li>ver1.3：Cmaj7/Cmaj9へ内部ID統一</li>
      </ul>
    </div>

    <div class="box">
      <div class="block" id="blk_basic">
        <div class="block-title">① BASIC：基本クオリティ</div>

        <div class="opt-row">
          <button class="btn" id="basic_activeBtn"><span>アクティブ</span><small id="basic_activeStat">ON</small></button>
          <div class="oct-pair">
            <button class="oct-btn" id="basic_octMinus">Oct-</button>
            <button class="oct-btn" id="basic_octPlus">Oct+</button>
          </div>
        </div>

        <div class="opt-row">
          <button class="btn" id="basic_invBtn"><span>転回形</span><small id="basic_invStat">OFF</small></button>
          <div></div>
        </div>
      </div>

      <div class="block" id="blk_plus">
        <div class="block-title">② PLUS：追加クオリティ</div>

        <div class="opt-row">
          <button class="btn" id="plus_activeBtn"><span>アクティブ</span><small id="plus_activeStat">OFF</small></button>
          <div class="oct-pair">
            <button class="oct-btn" id="plus_octMinus">Oct-</button>
            <button class="oct-btn" id="plus_octPlus">Oct+</button>
          </div>
        </div>

        <div class="opt-row">
          <button class="btn" id="plus_invBtn"><span>転回形</span><small id="plus_invStat">OFF</small></button>
          <div></div>
        </div>
      </div>

      <div class="block" id="blk_hard">
        <div class="block-title">③ HARD：難度高め</div>

        <div class="opt-row">
          <button class="btn" id="hard_activeBtn"><span>アクティブ</span><small id="hard_activeStat">OFF</small></button>
          <div class="oct-pair">
            <button class="oct-btn" id="hard_octMinus">Oct-</button>
            <button class="oct-btn" id="hard_octPlus">Oct+</button>
          </div>
        </div>

        <div class="opt-row">
          <button class="btn" id="hard_invBtn"><span>転回形</span><small id="hard_invStat">OFF</small></button>
          <div></div>
        </div>
      </div>

      <div class="note">※ 転回形はボイシング差分を含みます。</div>

      <div class="btn-row">
        <button class="ctrl" id="btnStart">出題</button>
        <button class="ctrl" id="btnReplay" disabled>もう一回</button>
        <button class="ctrl" id="btnReveal" disabled>答え</button>
        <button class="ctrl" id="btnHint" disabled>ヒント</button>
        <button class="ctrl" id="btnC">C（基準音）</button>
      </div>

      <div id="status" class="status">まだ出題していません</div>
      <div id="hintArea" class="hintArea"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;">選択肢</div>
      <div class="grid" id="opts"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;">答え</div>
      <div id="answerText" class="muted">未表示</div>
    </div>

    <div class="box">
      <div class="scorebar">
        <div>スコア： <span id="score">0</span>/<span id="total">0</span></div>
        <div id="accuracy" class="accuracy">正答率 00%</div>
      </div>
    </div>

    <div class="backwrap">
      <a class="backbtn" href="../../index.html">← ポータルに戻る</a>
    </div>
  </div>

  <script>
  (() => {
    const VER = "1.3";
    document.getElementById("verText").textContent = "ver" + VER;

    const AUDIO_BASE = "./audio/";
    const CACHE_BUSTER = "?v=" + encodeURIComponent(VER);
    const LOG_ENABLED = true;

    const BLOCKS = {
      basic: {
        label: "BASIC",
        chords: [
          {id:"C",label:"C",hint:"長3度のまっすぐな明るさ",inv:2},
          {id:"Cm",label:"Cm",hint:"短3度の影",inv:2},
          {id:"C7",label:"C7",hint:"行きたがるドミナント感",inv:3},
          {id:"Cm7",label:"Cm7",hint:"マイナー＋♭7",inv:3},
          {id:"Cmaj7",label:"CM7",hint:"Maj7の都会感",inv:3}
        ]
      },
      plus: {
        label: "PLUS",
        chords: [
          {id:"Csus4",label:"Csus4",hint:"3度を外した保留",inv:2},
          {id:"Cadd9",label:"Cadd9",hint:"開放的な9th",inv:3},
          {id:"Cdim",label:"Cdim",hint:"減5度の不安",inv:2},
          {id:"Caug",label:"Caug",hint:"増5度の浮遊",inv:2},
          {id:"CmM7",label:"CmM7",hint:"妖しい切なさ",inv:3}
        ]
      },
      hard: {
        label: "HARD",
        chords: [
          {id:"Csus2",label:"Csus2",hint:"軽い保留",inv:2},
          {id:"C7sus2",label:"C7sus2",hint:"行きたいが言い切らない",inv:3},
          {id:"C6",label:"C6",hint:"6thの温かさ",inv:3},
          {id:"Cm6",label:"Cm6",hint:"影に灯り",inv:3},
          {id:"C9",label:"C9",hint:"7より柔らかい濁り",inv:3},
          {id:"Cmaj9",label:"CM9",hint:"広く透明",inv:3},
          {id:"Cm9",label:"Cm9",hint:"影の広がり",inv:3},
          {id:"Cdim7",label:"Cdim7",hint:"回る不安",inv:3}
        ]
      }
    };

    const STATE = {
      basic: { active: true, octMinus: false, octPlus: false, inversion: false },
      plus: { active: false, octMinus: false, octPlus: false, inversion: false },
      hard: { active: false, octMinus: false, octPlus: false, inversion: false }
    };

    const ORDER = ["basic", "plus", "hard"];

    let current = null;
    let locked = true;
    let pendingWrong = false;

    let score = 0;
    let total = 0;

    let warmupDone = false;
    let warmupContext = null;

    const audio = new Audio();
    const snippetAudio = new Audio();

    const $ = id => document.getElementById(id);
    const opts = $("opts");
    const status = $("status");
    const hintArea = $("hintArea");
    const answerText = $("answerText");
    const scoreEl = $("score");
    const totalEl = $("total");
    const accuracyEl = $("accuracy");

    function updateAccuracy(){
      const acc = total === 0 ? 0 : Math.round(score / total * 100);
      accuracyEl.textContent = "正答率 " + String(acc).padStart(2,"0") + "%";
      accuracyEl.classList.toggle("good", acc >= 80);
    }

    function getActiveBlocks(){
      return ORDER.filter(key => STATE[key].active);
    }

    function getActiveChords(){
      const list = [];
      getActiveBlocks().forEach(key => {
        BLOCKS[key].chords.forEach(chord => list.push({ ...chord, blockKey: key }));
      });
      return list;
    }

    function getActiveOctaves(blockKey){
      const octs = [3];
      if(STATE[blockKey].octMinus) octs.unshift(2);
      if(STATE[blockKey].octPlus) octs.push(4);
      return octs;
    }

    function buildAudioPath(chordId, octave, inversion){
      const suffix = inversion ? `_inv${inversion}_${octave}.mp3` : `_${octave}.mp3`;
      return `${AUDIO_BASE}${octave}/${chordId}${suffix}`;
    }

    function withCache(path){
      return `${path}${CACHE_BUSTER}`;
    }

    async function checkUrl(url){
      try{
        const res = await fetch(url, { method: "HEAD" });
        return res.ok;
      }catch(e){
        return false;
      }
    }

    async function filterExistingCandidates(candidates){
      const checks = await Promise.all(candidates.map(async candidate => {
        const ok = await checkUrl(candidate.url);
        return ok ? candidate : null;
      }));
      return checks.filter(Boolean);
    }

    function buildCandidates(chord){
      const octs = getActiveOctaves(chord.blockKey);
      const list = [];
      octs.forEach(oct => {
        const rootPath = buildAudioPath(chord.id, oct, 0);
        list.push({
          chord,
          octave: oct,
          inversion: 0,
          path: rootPath,
          url: withCache(rootPath)
        });
        if(STATE[chord.blockKey].inversion){
          for(let i = 1; i <= chord.inv; i += 1){
            const invPath = buildAudioPath(chord.id, oct, i);
            list.push({
              chord,
              octave: oct,
              inversion: i,
              path: invPath,
              url: withCache(invPath)
            });
          }
        }
      });
      return list;
    }

    function buildOptions(){
      opts.innerHTML = "";
      const chords = getActiveChords();
      chords.forEach(q => {
        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = q.label;
        b.disabled = true;
        b.onclick = () => answer(q, b);
        opts.appendChild(b);
      });
    }

    function enableOptions(on){
      [...opts.children].forEach(b => b.disabled = !on);
    }

    function stopAudio(target){
      target.pause();
      target.currentTime = 0;
    }

    function playAudio(url){
      audio.src = url;
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }

    function playSnippet(url, durationMs){
      if(!url) return;
      snippetAudio.src = url;
      snippetAudio.currentTime = 0;
      snippetAudio.play().catch(() => {});
      window.setTimeout(() => stopAudio(snippetAudio), durationMs);
    }

    async function warmupAudio(){
      if(warmupDone) return;
      warmupDone = true;
      try{
        if(!warmupContext){
          warmupContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(warmupContext.state === "suspended"){
          await warmupContext.resume();
        }
        const osc = warmupContext.createOscillator();
        const gain = warmupContext.createGain();
        gain.gain.value = 0;
        osc.frequency.value = 440;
        osc.connect(gain).connect(warmupContext.destination);
        osc.start();
        osc.stop(warmupContext.currentTime + 0.05);
        await new Promise(resolve => setTimeout(resolve, 60));
      }catch(e){
        warmupDone = true;
      }
    }

    function logSelection(candidate){
      if(!LOG_ENABLED) return;
      console.log("[qualities] octave:", candidate.octave, "chordId:", candidate.chord.id, "url:", candidate.url);
    }

    async function start(){
      const chords = getActiveChords();
      if(chords.length === 0){
        status.textContent = "アクティブなセットがありません。";
        status.classList.add("warn");
        return;
      }

      const chosenChord = chords[Math.floor(Math.random() * chords.length)];
      const candidates = buildCandidates(chosenChord);
      const available = await filterExistingCandidates(candidates);

      let selected = null;
      if(available.length > 0){
        selected = available[Math.floor(Math.random() * available.length)];
      }else{
        const fallbackPath = buildAudioPath(chosenChord.id, 3, 0);
        const fallbackUrl = withCache(fallbackPath);
        const exists = await checkUrl(fallbackUrl);
        if(exists){
          selected = {
            chord: chosenChord,
            octave: 3,
            inversion: 0,
            path: fallbackPath,
            url: fallbackUrl
          };
        }
      }

      if(!selected){
        status.textContent = "音源が見つかりません。再試行してください。";
        status.classList.add("warn");
        locked = true;
        enableOptions(false);
        $("btnReplay").disabled = true;
        $("btnHint").disabled = true;
        $("btnReveal").disabled = true;
        return;
      }

      current = {
        chord: selected.chord,
        audioUrl: selected.url,
        octave: selected.octave,
        inversion: selected.inversion
      };

      locked = false;
      pendingWrong = false;
      status.textContent = "出題中";
      status.classList.remove("warn");
      hintArea.style.display = "none";
      hintArea.textContent = "";
      answerText.textContent = "未表示";
      [...opts.children].forEach(b => b.classList.remove("ok", "ng"));
      enableOptions(true);
      logSelection(selected);
      playAudio(selected.url);
      $("btnReplay").disabled = false;
      $("btnHint").disabled = false;
      $("btnReveal").disabled = false;
    }

    function endQuestion(){
      locked = true;
      enableOptions(false);
      $("btnReplay").disabled = true;
      $("btnHint").disabled = true;
      $("btnReveal").disabled = true;
    }

    function answer(choice, btn){
      if(locked) return;

      if(choice.id === current.chord.id){
        total += 1;
        score += 1;
        scoreEl.textContent = score;
        totalEl.textContent = total;
        updateAccuracy();
        btn.classList.add("ok");
        status.textContent = "正解！ 次は出題してください。";
        stopAudio(audio);
        playSnippet(current.audioUrl, 500);
        endQuestion();
      }else{
        btn.classList.add("ng");
        pendingWrong = true;
        status.textContent = "不正解… 再挑戦しますか？";
        locked = true;
        enableOptions(false);
      }
    }

    $("btnStart").onclick = async () => {
      if(pendingWrong){
        total += 1;
        totalEl.textContent = total;
        updateAccuracy();
        pendingWrong = false;
      }
      await warmupAudio();
      start();
    };

    $("btnReplay").onclick = () => {
      if(!current) return;
      playAudio(current.audioUrl);
      if(pendingWrong){
        locked = false;
        enableOptions(true);
        status.textContent = "再挑戦どうぞ";
      }
    };

    $("btnReveal").onclick = () => {
      if(!current) return;
      total += 1;
      totalEl.textContent = total;
      updateAccuracy();
      pendingWrong = false;
      answerText.textContent = "答え：" + current.chord.label;
      status.textContent = "答えを表示しました";
      endQuestion();
    };

    $("btnHint").onclick = () => {
      if(!current) return;
      hintArea.textContent = current.chord.hint;
      hintArea.style.display = "block";
    };

    $("btnC").onclick = () => {
      const basePath = buildAudioPath("C", 3, 0);
      playAudio(withCache(basePath));
    };

    function applyToggle(btn, statEl, isOn){
      btn.classList.toggle("on", isOn);
      if(statEl){
        statEl.textContent = isOn ? "ON" : "OFF";
      }
    }

    function bindBlockControls(blockKey){
      const activeBtn = $(`${blockKey}_activeBtn`);
      const activeStat = $(`${blockKey}_activeStat`);
      const invBtn = $(`${blockKey}_invBtn`);
      const invStat = $(`${blockKey}_invStat`);
      const octMinusBtn = $(`${blockKey}_octMinus`);
      const octPlusBtn = $(`${blockKey}_octPlus`);

      applyToggle(activeBtn, activeStat, STATE[blockKey].active);
      applyToggle(invBtn, invStat, STATE[blockKey].inversion);
      applyToggle(octMinusBtn, null, STATE[blockKey].octMinus);
      applyToggle(octPlusBtn, null, STATE[blockKey].octPlus);

      activeBtn.onclick = () => {
        STATE[blockKey].active = !STATE[blockKey].active;
        applyToggle(activeBtn, activeStat, STATE[blockKey].active);
        buildOptions();
        status.textContent = "セット変更しました";
        status.classList.remove("warn");
      };

      invBtn.onclick = () => {
        STATE[blockKey].inversion = !STATE[blockKey].inversion;
        applyToggle(invBtn, invStat, STATE[blockKey].inversion);
      };

      octMinusBtn.onclick = () => {
        STATE[blockKey].octMinus = !STATE[blockKey].octMinus;
        applyToggle(octMinusBtn, null, STATE[blockKey].octMinus);
      };

      octPlusBtn.onclick = () => {
        STATE[blockKey].octPlus = !STATE[blockKey].octPlus;
        applyToggle(octPlusBtn, null, STATE[blockKey].octPlus);
      };
    }

    ORDER.forEach(bindBlockControls);
    buildOptions();
  })();
  </script>
</body>
</html>
